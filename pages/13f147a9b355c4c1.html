<h1 id="辅助模块单元测试">辅助模块单元测试</h1>

<h2 id="准备工作">准备工作</h2>

<p>通常我们会优先为一个库的辅助方法编写测试，我们会优先为 <code class="language-plaintext highlighter-rouge">ts-axios</code> 库的 <code class="language-plaintext highlighter-rouge">helpers</code> 目录下的模块编写测试。我们在 <code class="language-plaintext highlighter-rouge">test</code> 目录下创建一个 <code class="language-plaintext highlighter-rouge">helpers</code> 目录，创建一个 <code class="language-plaintext highlighter-rouge">boot.ts</code> 空文件，这个是因为我们上节课给 Jest 配置了 <code class="language-plaintext highlighter-rouge">setupFilesAfterEnv</code> 指向了这个文件，后面的章节我们会编写这个文件。</p>

<p>然后我们可以在控制台运行 <code class="language-plaintext highlighter-rouge">npm test</code>，它实际上是执行了 <code class="language-plaintext highlighter-rouge">jest --coverage</code> 来跑单元测试，我们会发现它会报错，没有匹配的测试文件，那是因为我们还没有在 <code class="language-plaintext highlighter-rouge">test</code> 目录下编写任何一个 .spec.ts 结尾的测试文件。接下来我们就来为这些辅助模块编写相应的测试。</p>

<h2 id="util-模块测试">util 模块测试</h2>

<p><code class="language-plaintext highlighter-rouge">test/helpers/util.spec.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span>
  <span class="nx">isDate</span><span class="p">,</span>
  <span class="nx">isPlainObject</span><span class="p">,</span>
  <span class="nx">isFormData</span><span class="p">,</span>
  <span class="nx">isURLSearchParams</span><span class="p">,</span>
  <span class="nx">extend</span><span class="p">,</span>
  <span class="nx">deepMerge</span>
<span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../src/helpers/util</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">helpers:util</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">isXX</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should validate Date</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isDate</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">())).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isDate</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">())).</span><span class="nx">toBeFalsy</span><span class="p">()</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should validate PlainObject</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isPlainObject</span><span class="p">({})).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isPlainObject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">())).</span><span class="nx">toBeFalsy</span><span class="p">()</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should validate FormData</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isFormData</span><span class="p">(</span><span class="k">new</span> <span class="nx">FormData</span><span class="p">())).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isFormData</span><span class="p">({})).</span><span class="nx">toBeFalsy</span><span class="p">()</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should validate URLSearchParams</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isURLSearchParams</span><span class="p">(</span><span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">())).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isURLSearchParams</span><span class="p">(</span><span class="dl">'</span><span class="s1">foo=1&amp;bar=2</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBeFalsy</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">extend</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should be mutable</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
      <span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="p">{</span> <span class="na">foo</span><span class="p">:</span> <span class="mi">123</span> <span class="p">}</span>

      <span class="nx">extend</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">foo</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should extend properties</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span> <span class="na">foo</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span> <span class="na">bar</span><span class="p">:</span> <span class="mi">456</span> <span class="p">}</span>
      <span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="p">{</span> <span class="na">bar</span><span class="p">:</span> <span class="mi">789</span> <span class="p">}</span>
      <span class="kd">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">foo</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">bar</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">789</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">deepMerge</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should be immutable</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
      <span class="kd">const</span> <span class="na">b</span><span class="p">:</span> <span class="kr">any</span> <span class="o">=</span> <span class="p">{</span> <span class="na">foo</span><span class="p">:</span> <span class="mi">123</span> <span class="p">}</span>
      <span class="kd">const</span> <span class="na">c</span><span class="p">:</span> <span class="kr">any</span> <span class="o">=</span> <span class="p">{</span> <span class="na">bar</span><span class="p">:</span> <span class="mi">456</span> <span class="p">}</span>

      <span class="nx">deepMerge</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>

      <span class="nx">expect</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">a</span><span class="p">.</span><span class="nx">foo</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">a</span><span class="p">.</span><span class="nx">bar</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">b</span><span class="p">.</span><span class="nx">bar</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">c</span><span class="p">.</span><span class="nx">foo</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should deepMerge properties</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span> <span class="na">foo</span><span class="p">:</span> <span class="mi">123</span> <span class="p">}</span>
      <span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="p">{</span> <span class="na">bar</span><span class="p">:</span> <span class="mi">456</span> <span class="p">}</span>
      <span class="kd">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">{</span> <span class="na">foo</span><span class="p">:</span> <span class="mi">789</span> <span class="p">}</span>
      <span class="kd">const</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">deepMerge</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">foo</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">789</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">bar</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">456</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should deepMerge recursively</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span> <span class="na">foo</span><span class="p">:</span> <span class="p">{</span> <span class="na">bar</span><span class="p">:</span> <span class="mi">123</span> <span class="p">}</span> <span class="p">}</span>
      <span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="p">{</span> <span class="na">foo</span><span class="p">:</span> <span class="p">{</span> <span class="na">baz</span><span class="p">:</span> <span class="mi">456</span> <span class="p">},</span> <span class="na">bar</span><span class="p">:</span> <span class="p">{</span> <span class="na">qux</span><span class="p">:</span> <span class="mi">789</span> <span class="p">}</span> <span class="p">}</span>
      <span class="kd">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">deepMerge</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">c</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span>
        <span class="na">foo</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">bar</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
          <span class="na">baz</span><span class="p">:</span> <span class="mi">456</span>
        <span class="p">},</span>
        <span class="na">bar</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">qux</span><span class="p">:</span> <span class="mi">789</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should remove all references from nested objects</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span> <span class="na">foo</span><span class="p">:</span> <span class="p">{</span> <span class="na">bar</span><span class="p">:</span> <span class="mi">123</span> <span class="p">}</span> <span class="p">}</span>
      <span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="kd">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">deepMerge</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">c</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span>
        <span class="na">foo</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">bar</span><span class="p">:</span> <span class="mi">123</span>
        <span class="p">}</span>
      <span class="p">})</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">foo</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">foo</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should handle null and undefined arguments</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">deepMerge</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">)).</span><span class="nx">toEqual</span><span class="p">({})</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">deepMerge</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="p">{</span> <span class="na">foo</span><span class="p">:</span> <span class="mi">123</span> <span class="p">})).</span><span class="nx">toEqual</span><span class="p">({</span> <span class="na">foo</span><span class="p">:</span> <span class="mi">123</span> <span class="p">})</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">deepMerge</span><span class="p">({</span> <span class="na">foo</span><span class="p">:</span> <span class="mi">123</span> <span class="p">},</span> <span class="kc">undefined</span><span class="p">)).</span><span class="nx">toEqual</span><span class="p">({</span> <span class="na">foo</span><span class="p">:</span> <span class="mi">123</span> <span class="p">})</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">deepMerge</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">)).</span><span class="nx">toEqual</span><span class="p">({})</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">deepMerge</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="na">foo</span><span class="p">:</span> <span class="mi">123</span> <span class="p">})).</span><span class="nx">toEqual</span><span class="p">({</span> <span class="na">foo</span><span class="p">:</span> <span class="mi">123</span> <span class="p">})</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">deepMerge</span><span class="p">({</span> <span class="na">foo</span><span class="p">:</span> <span class="mi">123</span> <span class="p">},</span> <span class="kc">null</span><span class="p">)).</span><span class="nx">toEqual</span><span class="p">({</span> <span class="na">foo</span><span class="p">:</span> <span class="mi">123</span> <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>其中 <a href="https://jestjs.io/docs/en/api#describename-fn"><code class="language-plaintext highlighter-rouge">describe</code></a> 方法用来定义一组测试，它可以支持嵌套，<a href="https://jestjs.io/docs/en/api#testname-fn-timeout"><code class="language-plaintext highlighter-rouge">test</code></a> 函数是用来定义单个测试用例，它是测试的最小单元。<a href="https://jestjs.io/docs/en/expect#expectvalue"><code class="language-plaintext highlighter-rouge">expect</code></a> 是断言函数，所谓”断言”，就是判断代码的实际执行结果与预期结果是否一致，如果不一致就抛出一个错误。</p>

<p>测试文件编写好后，我们可以去控制台运行一次 <code class="language-plaintext highlighter-rouge">npm test</code>，看一下测试结果，我们可以看跑了几个测试文件，测试是否通过，测试覆盖率等。</p>

<h2 id="cookie-模块测试">cookie 模块测试</h2>

<p><code class="language-plaintext highlighter-rouge">test/helpers/cookie.spec.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">cookie</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../src/helpers/cookie</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">helpers:cookie</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should read cookies</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">foo=baz</span><span class="dl">'</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="dl">'</span><span class="s1">foo</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">baz</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should return null if cookie name is not exist</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">foo=baz</span><span class="dl">'</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBeNull</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>这里我们可以通过 <code class="language-plaintext highlighter-rouge">document.cookie</code> 去设置 cookie，就像在浏览器里一样操作。</p>

<h2 id="data-模块测试">data 模块测试</h2>

<p><code class="language-plaintext highlighter-rouge">test/helpers/data.spec.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">transformRequest</span><span class="p">,</span> <span class="nx">transformResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../src/helpers/data</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">helpers:data</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">transformRequest</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should transform request data to string if data is a PlainObject</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span> <span class="na">a</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">transformRequest</span><span class="p">(</span><span class="nx">a</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"a":1}</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should do nothing if data is not a PlainObject</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">(</span><span class="dl">'</span><span class="s1">a=b</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">transformRequest</span><span class="p">(</span><span class="nx">a</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">transformResponse</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should transform response data to Object if data is a JSON string</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">{"a": 2}</span><span class="dl">'</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">transformResponse</span><span class="p">(</span><span class="nx">a</span><span class="p">)).</span><span class="nx">toEqual</span><span class="p">({</span> <span class="na">a</span><span class="p">:</span> <span class="mi">2</span> <span class="p">})</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should do nothing if data is a string but not a JSON string</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">{a: 2}</span><span class="dl">'</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">transformResponse</span><span class="p">(</span><span class="nx">a</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">{a: 2}</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should do nothing if data is not a string</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">{</span> <span class="na">a</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">transformResponse</span><span class="p">(</span><span class="nx">a</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="error-模块测试">error 模块测试</h2>

<p><code class="language-plaintext highlighter-rouge">test/helpers/error.spec.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">createError</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../src/helpers/error</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AxiosRequestConfig</span><span class="p">,</span> <span class="nx">AxiosResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../src/types</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">helpers::error</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should create an Error with message, config, code, request, response and isAxiosError</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">()</span>
    <span class="kd">const</span> <span class="na">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span> <span class="o">=</span> <span class="p">{</span> <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">post</span><span class="dl">'</span> <span class="p">}</span>
    <span class="kd">const</span> <span class="na">response</span><span class="p">:</span> <span class="nx">AxiosResponse</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
      <span class="na">statusText</span><span class="p">:</span> <span class="dl">'</span><span class="s1">OK</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">headers</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">request</span><span class="p">,</span>
      <span class="nx">config</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">error</span> <span class="o">=</span> <span class="nx">createError</span><span class="p">(</span><span class="dl">'</span><span class="s1">Boom!</span><span class="dl">'</span><span class="p">,</span> <span class="nx">config</span><span class="p">,</span> <span class="dl">'</span><span class="s1">SOMETHING</span><span class="dl">'</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">error</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Boom!</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">config</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">SOMETHING</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">request</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">response</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">isAxiosError</span><span class="p">).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>该模块跑完我们会发现，分支覆盖率是在 <code class="language-plaintext highlighter-rouge">50%</code>，因为第十七行代码</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">super</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</code></pre></div></div>

<p>这个是 <code class="language-plaintext highlighter-rouge">super</code> 继承对测试覆盖率支持的坑，目前没有好的解决方案，可以先忽略。</p>

<h2 id="headers-模块测试">headers 模块测试</h2>

<p><code class="language-plaintext highlighter-rouge">test/helpers/headers.spec.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">parseHeaders</span><span class="p">,</span> <span class="nx">processHeaders</span><span class="p">,</span> <span class="nx">flattenHeaders</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../src/helpers/headers</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">helpers:header</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">parseHeaders</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should parse headers</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">parseHeaders</span><span class="p">(</span>
        <span class="dl">'</span><span class="s1">Content-Type: application/json</span><span class="se">\r\n</span><span class="dl">'</span> <span class="o">+</span>
          <span class="dl">'</span><span class="s1">Connection: keep-alive</span><span class="se">\r\n</span><span class="dl">'</span> <span class="o">+</span>
          <span class="dl">'</span><span class="s1">Transfer-Encoding: chunked</span><span class="se">\r\n</span><span class="dl">'</span> <span class="o">+</span>
          <span class="dl">'</span><span class="s1">Date: Tue, 21 May 2019 09:23:44 GMT</span><span class="se">\r\n</span><span class="dl">'</span> <span class="o">+</span>
          <span class="dl">'</span><span class="s1">:aa</span><span class="se">\r\n</span><span class="dl">'</span> <span class="o">+</span>
          <span class="dl">'</span><span class="s1">key:</span><span class="dl">'</span>
      <span class="p">)</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">parsed</span><span class="p">[</span><span class="dl">'</span><span class="s1">content-type</span><span class="dl">'</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">parsed</span><span class="p">[</span><span class="dl">'</span><span class="s1">connection</span><span class="dl">'</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">keep-alive</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">parsed</span><span class="p">[</span><span class="dl">'</span><span class="s1">transfer-encoding</span><span class="dl">'</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">chunked</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">parsed</span><span class="p">[</span><span class="dl">'</span><span class="s1">date</span><span class="dl">'</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Tue, 21 May 2019 09:23:44 GMT</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">parsed</span><span class="p">[</span><span class="dl">'</span><span class="s1">key</span><span class="dl">'</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">''</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should return empty object if headers is empty string</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">parseHeaders</span><span class="p">(</span><span class="dl">''</span><span class="p">)).</span><span class="nx">toEqual</span><span class="p">({})</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">processHeaders</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should normalize Content-Type header name</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="na">headers</span><span class="p">:</span> <span class="kr">any</span> <span class="o">=</span> <span class="p">{</span>
        <span class="dl">'</span><span class="s1">conTenT-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">foo/bar</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">Content-length</span><span class="dl">'</span><span class="p">:</span> <span class="mi">1024</span>
      <span class="p">}</span>
      <span class="nx">processHeaders</span><span class="p">(</span><span class="nx">headers</span><span class="p">,</span> <span class="p">{})</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">foo/bar</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">conTenT-Type</span><span class="dl">'</span><span class="p">]).</span><span class="nx">toBeUndefined</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">Content-length</span><span class="dl">'</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should set Content-Type if not set and data is PlainObject</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="na">headers</span><span class="p">:</span> <span class="kr">any</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="nx">processHeaders</span><span class="p">(</span><span class="nx">headers</span><span class="p">,</span> <span class="p">{</span> <span class="na">a</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">application/json;charset=utf-8</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should set not Content-Type if not set and data is not PlainObject</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="na">headers</span><span class="p">:</span> <span class="kr">any</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="nx">processHeaders</span><span class="p">(</span><span class="nx">headers</span><span class="p">,</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">(</span><span class="dl">'</span><span class="s1">a=b</span><span class="dl">'</span><span class="p">))</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">]).</span><span class="nx">toBeUndefined</span><span class="p">()</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should do nothing if headers is undefined or null</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">processHeaders</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="p">{})).</span><span class="nx">toBeUndefined</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">processHeaders</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{})).</span><span class="nx">toBeNull</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">flattenHeaders</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should flatten the headers and include common headers</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">Accept</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">common</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">'</span><span class="s1">X-COMMON-HEADER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">commonHeaderValue</span><span class="dl">'</span>
        <span class="p">},</span>
        <span class="na">get</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">'</span><span class="s1">X-GET-HEADER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">getHeaderValue</span><span class="dl">'</span>
        <span class="p">},</span>
        <span class="na">post</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">'</span><span class="s1">X-POST-HEADER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">postHeaderValue</span><span class="dl">'</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">flattenHeaders</span><span class="p">(</span><span class="nx">headers</span><span class="p">,</span> <span class="dl">'</span><span class="s1">get</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toEqual</span><span class="p">({</span>
        <span class="na">Accept</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">X-COMMON-HEADER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">commonHeaderValue</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">X-GET-HEADER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">getHeaderValue</span><span class="dl">'</span>
      <span class="p">})</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should flatten the headers without common headers</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">Accept</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">get</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">'</span><span class="s1">X-GET-HEADER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">getHeaderValue</span><span class="dl">'</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">flattenHeaders</span><span class="p">(</span><span class="nx">headers</span><span class="p">,</span> <span class="dl">'</span><span class="s1">patch</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toEqual</span><span class="p">({</span>
        <span class="na">Accept</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span>
      <span class="p">})</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should do nothing if headers is undefined or null</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">flattenHeaders</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="dl">'</span><span class="s1">get</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBeUndefined</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">flattenHeaders</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBeNull</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>运行后，我们会发现 <code class="language-plaintext highlighter-rouge">parseHeaders</code> 测试组的 <code class="language-plaintext highlighter-rouge">should parse headers</code> 测试没通过，<code class="language-plaintext highlighter-rouge">expect(parsed['date']).toBe('Tue, 21 May 2019 09:23:44 GMT')</code> 我们期望解析后的 <code class="language-plaintext highlighter-rouge">date</code> 字段是 <code class="language-plaintext highlighter-rouge">Tue, 21 May 2019 09:23:44 GMT</code>，而实际的值是 <code class="language-plaintext highlighter-rouge">Tue, 21 May 2019 09</code>。</p>

<p>测试没通过，我们检查一下代码，发现我们 <code class="language-plaintext highlighter-rouge">parseHeaders</code> 的代码逻辑漏洞，我们只考虑了第一个 “:” 号，没考虑后半部分的字符串内部也可能有 “:”，按我们现有的逻辑就会把字符串中 “:” 后面部分都截断了。</p>

<p>因此我们修改 <code class="language-plaintext highlighter-rouge">parseHeaders</code> 的实现逻辑。</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">parseHeaders</span><span class="p">(</span><span class="nx">headers</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="kr">any</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">parsed</span>
  <span class="p">}</span>

  <span class="nx">headers</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="se">\r\n</span><span class="dl">'</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">line</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="p">...</span><span class="nx">vals</span><span class="p">]</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">vals</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">).</span><span class="nx">trim</span><span class="p">()</span>
    <span class="nx">parsed</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
  <span class="p">})</span>

  <span class="k">return</span> <span class="nx">parsed</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这样我们再重新跑测试，就会通过了。</p>

<h2 id="url-模块测试">url 模块测试</h2>

<p><code class="language-plaintext highlighter-rouge">test/helpers/url.spec.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">buildURL</span><span class="p">,</span> <span class="nx">isAbsoluteURL</span><span class="p">,</span> <span class="nx">combineURL</span><span class="p">,</span> <span class="nx">isURLSameOrigin</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../src/helpers/url</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">helpers:url</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">buildURL</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should support null params</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">buildURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should support params</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span>
        <span class="nx">buildURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span>
        <span class="p">})</span>
      <span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo?foo=bar</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should ignore if some param value is null</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span>
        <span class="nx">buildURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">baz</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">})</span>
      <span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo?foo=bar</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should ignore if the only param value is null</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span>
        <span class="nx">buildURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">baz</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">})</span>
      <span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should support object params</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span>
        <span class="nx">buildURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">foo</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">bar</span><span class="p">:</span> <span class="dl">'</span><span class="s1">baz</span><span class="dl">'</span>
          <span class="p">}</span>
        <span class="p">})</span>
      <span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo?foo=</span><span class="dl">'</span> <span class="o">+</span> <span class="nb">encodeURI</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"bar":"baz"}</span><span class="dl">'</span><span class="p">))</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should support date params</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>

      <span class="nx">expect</span><span class="p">(</span>
        <span class="nx">buildURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">date</span><span class="p">:</span> <span class="nx">date</span>
        <span class="p">})</span>
      <span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo?date=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">date</span><span class="p">.</span><span class="nx">toISOString</span><span class="p">())</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should support array params</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span>
        <span class="nx">buildURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">foo</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">baz</span><span class="dl">'</span><span class="p">]</span>
        <span class="p">})</span>
      <span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo?foo[]=bar&amp;foo[]=baz</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should support special char params</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span>
        <span class="nx">buildURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">@:$, </span><span class="dl">'</span>
        <span class="p">})</span>
      <span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo?foo=@:$,+</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should support existing params</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span>
        <span class="nx">buildURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo?foo=bar</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">bar</span><span class="p">:</span> <span class="dl">'</span><span class="s1">baz</span><span class="dl">'</span>
        <span class="p">})</span>
      <span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo?foo=bar&amp;bar=baz</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should correct discard url hash mark</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span>
        <span class="nx">buildURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo?foo=bar#hash</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">query</span><span class="p">:</span> <span class="dl">'</span><span class="s1">baz</span><span class="dl">'</span>
        <span class="p">})</span>
      <span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo?foo=bar&amp;query=baz</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should use serializer if provided</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">serializer</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="dl">'</span><span class="s1">foo=bar</span><span class="dl">'</span>
      <span class="p">})</span>
      <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span> <span class="p">}</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">buildURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">serializer</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo?foo=bar</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">serializer</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">serializer</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should support URLSearchParams</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">buildURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">(</span><span class="dl">'</span><span class="s1">bar=baz</span><span class="dl">'</span><span class="p">))).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo?bar=baz</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">isAbsoluteURL</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should return true if URL begins with valid scheme name</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isAbsoluteURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://api.github.com/users</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isAbsoluteURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">custom-scheme-v1.0://example.com/</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isAbsoluteURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">HTTP://example.com/</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should return false if URL begins with invalid scheme name</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isAbsoluteURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">123://example.com/</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBeFalsy</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isAbsoluteURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">!valid://example.com/</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBeFalsy</span><span class="p">()</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should return true if URL is protocol-relative</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isAbsoluteURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">//example.com/</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should return false if URL is relative</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isAbsoluteURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBeFalsy</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isAbsoluteURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">foo</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBeFalsy</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">combineURL</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should combine URL</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">combineURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://api.github.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://api.github.com/users</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should remove duplicate slashes</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">combineURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://api.github.com/</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/users</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://api.github.com/users</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should insert missing slash</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">combineURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://api.github.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">users</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://api.github.com/users</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should not insert slash when relative url missing/empty</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">combineURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://api.github.com/users</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://api.github.com/users</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should allow a single slash for relative url</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">combineURL</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://api.github.com/users</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://api.github.com/users/</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">isURLSameOrigin</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should detect same origin</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isURLSameOrigin</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">)).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should detect different origin</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">isURLSameOrigin</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://github.com/axios/axios</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBeFalsy</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>这里要注意的是，我们使用了 <a href="https://jestjs.io/docs/en/jest-object#jestfnimplementation"><code class="language-plaintext highlighter-rouge">jest.fn</code></a> 去模拟了一个函数，这个也是在编写 Jest 测试中非常常用的一个 API。</p>

<p>至此，我们就实现了 <code class="language-plaintext highlighter-rouge">ts-axios</code> 库 <code class="language-plaintext highlighter-rouge">helpers</code> 目录下所有模块的测试，并把该目录下的测试覆盖率达到了近乎 100% 的覆盖率。下面的章节我们就开始测试 <code class="language-plaintext highlighter-rouge">ts-axios</code> 的核心流程，针对不同的 <code class="language-plaintext highlighter-rouge">feature</code> 去编写单元测试了。</p>
