<h1 id="xsrf-防御">XSRF 防御</h1>

<h2 id="需求分析">需求分析</h2>

<p>XSRF 又名 <a href="https://developer.mozilla.org/en-US/docs/Learn/Server-side/First_steps/Website_security#Cross-Site_Request_Forgery_(CSRF)">CSRF</a>，跨站请求伪造，它是前端常见的一种攻击方式，我们先通过一张图来认识它的攻击手段。</p>

<p><img src="https://cdn.jsdelivr.net/gh/maoyln/maoyl-img/blog/20200105110743.png" alt="xsrf" title="xsrf" /></p>

<p>CSRF 的防御手段有很多，比如验证请求的 referer，但是 referer 也是可以伪造的，所以杜绝此类攻击的一种方式是服务器端要求每次请求都包含一个 <code class="language-plaintext highlighter-rouge">token</code>，这个 <code class="language-plaintext highlighter-rouge">token</code> 不在前端生成，而是在我们每次访问站点的时候生成，并通过 <code class="language-plaintext highlighter-rouge">set-cookie</code> 的方式种到客户端，然后客户端发送请求的时候，从 <code class="language-plaintext highlighter-rouge">cookie</code> 中对应的字段读取出 <code class="language-plaintext highlighter-rouge">token</code>，然后添加到请求 <code class="language-plaintext highlighter-rouge">headers</code> 中。这样服务端就可以从请求 <code class="language-plaintext highlighter-rouge">headers</code> 中读取这个 <code class="language-plaintext highlighter-rouge">token</code> 并验证，由于这个 <code class="language-plaintext highlighter-rouge">token</code> 是很难伪造的，所以就能区分这个请求是否是用户正常发起的。</p>

<p>对于我们的 <code class="language-plaintext highlighter-rouge">ts-axios</code> 库，我们要自动把这几件事做了，每次发送请求的时候，从 <code class="language-plaintext highlighter-rouge">cookie</code> 中读取对应的 <code class="language-plaintext highlighter-rouge">token</code> 值，然后添加到请求 <code class="language-plaintext highlighter-rouge">headers</code>中。我们允许用户配置 <code class="language-plaintext highlighter-rouge">xsrfCookieName</code> 和 <code class="language-plaintext highlighter-rouge">xsrfHeaderName</code>，其中 <code class="language-plaintext highlighter-rouge">xsrfCookieName</code> 表示存储 <code class="language-plaintext highlighter-rouge">token</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code> 名称，<code class="language-plaintext highlighter-rouge">xsrfHeaderName</code> 表示请求 <code class="language-plaintext highlighter-rouge">headers</code> 中 <code class="language-plaintext highlighter-rouge">token</code> 对应的 <code class="language-plaintext highlighter-rouge">header</code> 名称。</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/more/get</span><span class="dl">'</span><span class="p">,{</span>
  <span class="na">xsrfCookieName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">XSRF-TOKEN</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// default</span>
  <span class="na">xsrfHeaderName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">X-XSRF-TOKEN</span><span class="dl">'</span> <span class="c1">// default</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>我们提供 <code class="language-plaintext highlighter-rouge">xsrfCookieName</code> 和 <code class="language-plaintext highlighter-rouge">xsrfHeaderName</code> 的默认值，当然用户也可以根据自己的需求在请求中去配置 <code class="language-plaintext highlighter-rouge">xsrfCookieName</code> 和 <code class="language-plaintext highlighter-rouge">xsrfHeaderName</code>。</p>

<h2 id="代码实现">代码实现</h2>

<p>先修改 <code class="language-plaintext highlighter-rouge">AxiosRequestConfig</code> 的类型定义。</p>

<p><code class="language-plaintext highlighter-rouge">types/index.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kr">interface</span> <span class="nx">AxiosRequestConfig</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nl">xsrfCookieName</span><span class="p">?:</span> <span class="kr">string</span>
  <span class="nx">xsrfHeaderName</span><span class="p">?:</span> <span class="kr">string</span>
<span class="p">}</span>
</code></pre></div></div>

<p>然后修改默认配置。</p>

<p><code class="language-plaintext highlighter-rouge">defaults.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">defaults</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="na">xsrfCookieName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">XSRF-TOKEN</span><span class="dl">'</span><span class="p">,</span>

  <span class="na">xsrfHeaderName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">X-XSRF-TOKEN</span><span class="dl">'</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>接下来我们要做三件事：</p>

<ul>
  <li>
    <p>首先判断如果是配置 <code class="language-plaintext highlighter-rouge">withCredentials</code> 为 <code class="language-plaintext highlighter-rouge">true</code> 或者是同域请求，我们才会请求 <code class="language-plaintext highlighter-rouge">headers</code> 添加 <code class="language-plaintext highlighter-rouge">xsrf</code> 相关的字段。</p>
  </li>
  <li>
    <p>如果判断成功，尝试从 cookie 中读取 <code class="language-plaintext highlighter-rouge">xsrf</code> 的 <code class="language-plaintext highlighter-rouge">token</code> 值。</p>
  </li>
  <li>
    <p>如果能读到，则把它添加到请求 <code class="language-plaintext highlighter-rouge">headers</code> 的 <code class="language-plaintext highlighter-rouge">xsrf</code> 相关字段中。</p>
  </li>
</ul>

<p>我们先来实现同域请求的判断。</p>

<p><code class="language-plaintext highlighter-rouge">helpers/url.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">URLOrigin</span> <span class="p">{</span>
  <span class="nl">protocol</span><span class="p">:</span> <span class="kr">string</span>
  <span class="nx">host</span><span class="p">:</span> <span class="kr">string</span>
<span class="p">}</span>


<span class="k">export</span> <span class="kd">function</span> <span class="nx">isURLSameOrigin</span><span class="p">(</span><span class="nx">requestURL</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">parsedOrigin</span> <span class="o">=</span> <span class="nx">resolveURL</span><span class="p">(</span><span class="nx">requestURL</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="nx">parsedOrigin</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="nx">currentOrigin</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">&amp;&amp;</span> <span class="nx">parsedOrigin</span><span class="p">.</span><span class="nx">host</span> <span class="o">===</span> <span class="nx">currentOrigin</span><span class="p">.</span><span class="nx">host</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">urlParsingNode</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">a</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">currentOrigin</span> <span class="o">=</span> <span class="nx">resolveURL</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">resolveURL</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">URLOrigin</span> <span class="p">{</span>
  <span class="nx">urlParsingNode</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">href</span><span class="dl">'</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">protocol</span><span class="p">,</span> <span class="nx">host</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">urlParsingNode</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">protocol</span><span class="p">,</span>
    <span class="nx">host</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>同域名的判断主要利用了一个技巧，创建一个 a 标签的 DOM，然后设置 <code class="language-plaintext highlighter-rouge">href</code> 属性为我们传入的 <code class="language-plaintext highlighter-rouge">url</code>，然后可以获取该 DOM 的 <code class="language-plaintext highlighter-rouge">protocol</code>、<code class="language-plaintext highlighter-rouge">host</code>。当前页面的 <code class="language-plaintext highlighter-rouge">url</code> 和请求的 <code class="language-plaintext highlighter-rouge">url</code> 都通过这种方式获取，然后对比它们的 <code class="language-plaintext highlighter-rouge">protocol</code> 和 <code class="language-plaintext highlighter-rouge">host</code> 是否相同即可。</p>

<p>接着实现 cookie 的读取。</p>

<p><code class="language-plaintext highlighter-rouge">helpers/cookie.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">cookie</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">read</span><span class="p">(</span><span class="na">name</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="kr">string</span> <span class="o">|</span> <span class="kc">null</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="dl">'</span><span class="s1">(^|;</span><span class="se">\\</span><span class="s1">s*)(</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">)=([^;]*)</span><span class="dl">'</span><span class="p">))</span>
    <span class="k">return</span> <span class="nx">match</span> <span class="p">?</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">:</span> <span class="kc">null</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">cookie</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">cookie</code> 的读取逻辑很简单，利用了正则表达式可以解析到 <code class="language-plaintext highlighter-rouge">name</code> 对应的值。</p>

<p>最后实现完整的逻辑。</p>

<p><code class="language-plaintext highlighter-rouge">core/xhr.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span>
  <span class="cm">/*...*/</span>
  <span class="nx">xsrfCookieName</span><span class="p">,</span>
  <span class="nx">xsrfHeaderName</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">config</span>

<span class="k">if</span> <span class="p">((</span><span class="nx">withCredentials</span> <span class="o">||</span> <span class="nx">isURLSameOrigin</span><span class="p">(</span><span class="nx">url</span><span class="o">!</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="nx">xsrfCookieName</span><span class="p">){</span>
  <span class="kd">const</span> <span class="nx">xsrfValue</span> <span class="o">=</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">xsrfCookieName</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">xsrfValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">headers</span><span class="p">[</span><span class="nx">xsrfHeaderName</span><span class="o">!</span><span class="p">]</span> <span class="o">=</span> <span class="nx">xsrfValue</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="demo-编写">demo 编写</h2>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
  <span class="na">xsrfCookieName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">XSRF-TOKEN-D</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">xsrfHeaderName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">X-XSRF-TOKEN-D</span><span class="dl">'</span>
<span class="p">})</span>

<span class="nx">instance</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/more/get</span><span class="dl">'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">examples/server.js</code>：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kd">static</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">setHeaders</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="dl">'</span><span class="s1">XSRF-TOKEN-D</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">1234abc</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}))</span>
</code></pre></div></div>

<p>在访问页面的时候，服务端通过 <code class="language-plaintext highlighter-rouge">set-cookie</code> 往客户端种了 <code class="language-plaintext highlighter-rouge">key</code> 为 <code class="language-plaintext highlighter-rouge">XSRF-TOKEN</code>，值为 <code class="language-plaintext highlighter-rouge">1234abc</code> 的 <code class="language-plaintext highlighter-rouge">cookie</code>，作为 <code class="language-plaintext highlighter-rouge">xsrf</code> 的 <code class="language-plaintext highlighter-rouge">token</code> 值。</p>

<p>然后我们在前端发送请求的时候，就能从 cookie 中读出 <code class="language-plaintext highlighter-rouge">key</code> 为 <code class="language-plaintext highlighter-rouge">XSRF-TOKEN</code> 的值，然后把它添加到 <code class="language-plaintext highlighter-rouge">key</code> 为 <code class="language-plaintext highlighter-rouge">X-XSRF-TOKEN</code> 的请求 <code class="language-plaintext highlighter-rouge">headers</code> 中。</p>

<p>至此，我们实现了 XSRF 的自动防御的能力，下节课我们来实现 ts-axios 对上传和下载请求的支持。</p>
