<h1 id="axios-实例模块单元测试">Axios 实例模块单元测试</h1>

<p><code class="language-plaintext highlighter-rouge">ts-axios</code> 提供了 <code class="language-plaintext highlighter-rouge">axios.create</code> 静态方法，返回一个 <code class="language-plaintext highlighter-rouge">instance</code> 实例，我们需要对这个模块做测试。</p>

<h2 id="测试代码编写">测试代码编写</h2>

<p><code class="language-plaintext highlighter-rouge">test/instance.spec.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span><span class="p">,</span> <span class="p">{</span> <span class="nx">AxiosRequestConfig</span><span class="p">,</span> <span class="nx">AxiosResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../src/index</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">getAjaxRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./helper</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">instance</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">install</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">uninstall</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should make a http request without verb helper</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>

    <span class="nx">instance</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should make a http request</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>

    <span class="nx">instance</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should make a post request</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>

    <span class="nx">instance</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should make a put request</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>

    <span class="nx">instance</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">PUT</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should make a patch request</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>

    <span class="nx">instance</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">PATCH</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should make a options request</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>

    <span class="nx">instance</span><span class="p">.</span><span class="nx">options</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">OPTIONS</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should make a delete request</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>

    <span class="nx">instance</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">DELETE</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should make a head request</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>

    <span class="nx">instance</span><span class="p">.</span><span class="nx">head</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">HEAD</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should use instance options</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="na">timeout</span><span class="p">:</span> <span class="mi">1000</span> <span class="p">})</span>

    <span class="nx">instance</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">timeout</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should have defaults.headers</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="na">baseURL</span><span class="p">:</span> <span class="dl">'</span><span class="s1">https://api.example.com</span><span class="dl">'</span> <span class="p">})</span>

    <span class="nx">expect</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">common</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should have interceptors on the instance</span><span class="dl">'</span><span class="p">,</span> <span class="nx">done</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">axios</span><span class="p">.</span><span class="nx">interceptors</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">config</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">config</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="mi">2000</span>
      <span class="k">return</span> <span class="nx">config</span>
    <span class="p">})</span>

    <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>

    <span class="nx">instance</span><span class="p">.</span><span class="nx">interceptors</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">config</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">config</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="k">return</span> <span class="nx">config</span>
    <span class="p">})</span>

    <span class="kd">let</span> <span class="na">response</span><span class="p">:</span> <span class="nx">AxiosResponse</span>
    <span class="nx">instance</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span> <span class="o">=</span> <span class="nx">res</span>
    <span class="p">})</span>

    <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">({</span>
        <span class="na">status</span><span class="p">:</span> <span class="mi">200</span>
      <span class="p">})</span>

      <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">timeout</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">withCredentials</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
        <span class="nx">done</span><span class="p">()</span>
      <span class="p">},</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should get the computed uri</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="na">fakeConfig</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">baseURL</span><span class="p">:</span> <span class="dl">'</span><span class="s1">https://www.baidu.com/</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/user/12345</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">params</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">idClient</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="na">idTest</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="na">testString</span><span class="p">:</span> <span class="dl">'</span><span class="s1">thisIsATest</span><span class="dl">'</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">axios</span><span class="p">.</span><span class="nx">getUri</span><span class="p">(</span><span class="nx">fakeConfig</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span>
      <span class="dl">'</span><span class="s1">https://www.baidu.com/user/12345?idClient=1&amp;idTest=2&amp;testString=thisIsATest</span><span class="dl">'</span>
    <span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>至此我们完成了 <code class="language-plaintext highlighter-rouge">ts-axios</code> 库 <code class="language-plaintext highlighter-rouge">Axios</code> 实例模块相关业务逻辑的测试，下一节课我们会对拦截器模块做测试。</p>
