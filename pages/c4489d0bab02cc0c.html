<h1 id="响应数据支持泛型">响应数据支持泛型</h1>

<h2 id="需求分析">需求分析</h2>

<p>通常情况下，我们会把后端返回数据格式单独放入一个接口中：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 请求接口数据</span>
<span class="k">export</span> <span class="kr">interface</span> <span class="nx">ResponseData</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="cm">/**
   * 状态码
   * @type { number }
   */</span>
  <span class="na">code</span><span class="p">:</span> <span class="kr">number</span>

  <span class="cm">/**
   * 数据
   * @type { T }
   */</span>
  <span class="na">result</span><span class="p">:</span> <span class="nx">T</span>

  <span class="cm">/**
   * 消息
   * @type { string }
   */</span>
  <span class="na">message</span><span class="p">:</span> <span class="kr">string</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我们可以把 API 抽离成单独的模块：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">ResponseData</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./interface.ts</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">getUser</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">ResponseData</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="dl">'</span><span class="s1">/somepath</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<p>接着我们写入返回的数据类型 <code class="language-plaintext highlighter-rouge">User</code>，这可以让 TypeScript 顺利推断出我们想要的类型：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="nl">name</span><span class="p">:</span> <span class="kr">string</span>
  <span class="nx">age</span><span class="p">:</span> <span class="kr">number</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">test</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// user 被推断出为</span>
  <span class="c1">// {</span>
  <span class="c1">//  code: number,</span>
  <span class="c1">//  result: { name: string, age: number },</span>
  <span class="c1">//  message: string</span>
  <span class="c1">// }</span>
  <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getUser</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="接口添加泛型参数">接口添加泛型参数</h2>

<p>根据需求分析，我们需要给相关的接口定义添加泛型参数。</p>

<p><code class="language-plaintext highlighter-rouge">types/index.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kr">interface</span> <span class="nx">AxiosResponse</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="na">data</span><span class="p">:</span> <span class="nx">T</span>
  <span class="na">status</span><span class="p">:</span> <span class="kr">number</span>
  <span class="na">statusText</span><span class="p">:</span> <span class="kr">string</span>
  <span class="na">headers</span><span class="p">:</span> <span class="kr">any</span>
  <span class="na">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span>
  <span class="na">request</span><span class="p">:</span> <span class="kr">any</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">AxiosPromise</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">AxiosResponse</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">Axios</span> <span class="p">{</span>
  <span class="nx">request</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span>

  <span class="kd">get</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span>

  <span class="k">delete</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span>

  <span class="nx">head</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span>

  <span class="nx">options</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span>

  <span class="nx">post</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">data</span><span class="p">?:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span>

  <span class="nx">put</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">data</span><span class="p">?:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span>

  <span class="nx">patch</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">data</span><span class="p">?:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">AxiosInstance</span> <span class="kd">extends</span> <span class="nx">Axios</span> <span class="p">{</span>
  <span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span>

  <span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这里我们先给 <code class="language-plaintext highlighter-rouge">AxiosResponse</code> 接口添加了泛型参数 <code class="language-plaintext highlighter-rouge">T</code>，<code class="language-plaintext highlighter-rouge">T=any</code> 表示泛型的类型参数默认值为 <code class="language-plaintext highlighter-rouge">any</code>。</p>

<p>接着我们为 <code class="language-plaintext highlighter-rouge">AxiosPromise</code>、<code class="language-plaintext highlighter-rouge">Axios</code> 以及 <code class="language-plaintext highlighter-rouge">AxiosInstance</code> 接口都加上了泛型参数。我们可以看到这些请求的返回类型都变成了 <code class="language-plaintext highlighter-rouge">AxiosPromise&lt;T&gt;</code>，也就是 <code class="language-plaintext highlighter-rouge">Promise&lt;AxiosResponse&lt;T&gt;&gt;</code>，这样我们就可以从响应中拿到了类型 <code class="language-plaintext highlighter-rouge">T</code> 了。</p>

<h2 id="demo-编写">demo 编写</h2>

<p><code class="language-plaintext highlighter-rouge">examples/extend/app.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">ResponseData</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="kr">any</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="na">code</span><span class="p">:</span> <span class="kr">number</span>
  <span class="na">result</span><span class="p">:</span> <span class="nx">T</span>
  <span class="na">message</span><span class="p">:</span> <span class="kr">string</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="nl">name</span><span class="p">:</span> <span class="kr">string</span>
  <span class="nx">age</span><span class="p">:</span> <span class="kr">number</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getUser</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">axios</span><span class="o">&lt;</span><span class="nx">ResponseData</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="dl">'</span><span class="s1">/extend/user</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
<span class="p">}</span>


<span class="k">async</span> <span class="kd">function</span> <span class="nx">test</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getUser</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">test</span><span class="p">()</span>
</code></pre></div></div>

<p>当我们调用 <code class="language-plaintext highlighter-rouge">getUser&lt;User&gt;</code> 的时候，相当于调用了 <code class="language-plaintext highlighter-rouge">axios&lt;ResponseData&lt;User&gt;&gt;</code>，也就是我们传入给 <code class="language-plaintext highlighter-rouge">axios</code> 函数的类型 <code class="language-plaintext highlighter-rouge">T</code> 为 <code class="language-plaintext highlighter-rouge">ResponseData&lt;User&gt;</code>；相当于返回值 <code class="language-plaintext highlighter-rouge">AxiosPromise&lt;T&gt;</code> 的 <code class="language-plaintext highlighter-rouge">T</code>，实际上也是 <code class="language-plaintext highlighter-rouge">Promise&lt;AxiosResponse&lt;T&gt;&gt;</code> 中的 <code class="language-plaintext highlighter-rouge">T</code> 的类型是 <code class="language-plaintext highlighter-rouge">ResponseData&lt;User&gt;</code>，所以响应数据中的 <code class="language-plaintext highlighter-rouge">data</code> 类型就是 <code class="language-plaintext highlighter-rouge">ResponseData&lt;User&gt;</code>，也就是如下数据结构：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="err">code:</span><span class="w"> </span><span class="err">number</span><span class="w">
  </span><span class="err">result:</span><span class="w"> </span><span class="err">User</span><span class="w">
  </span><span class="err">message:</span><span class="w"> </span><span class="err">string</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>这个也是 <code class="language-plaintext highlighter-rouge">const user = await getUser&lt;User&gt;()</code> 返回值 <code class="language-plaintext highlighter-rouge">user</code> 的数据类型，所以 TypeScript 能正确推断出 <code class="language-plaintext highlighter-rouge">user</code> 的类型。</p>

<p>至此，我们的 <code class="language-plaintext highlighter-rouge">ts-axios</code> 接口扩展章节就告一段落了，下一章我们来实现 <code class="language-plaintext highlighter-rouge">axios</code> 的一个非常好用的功能 —— 拦截器。</p>
