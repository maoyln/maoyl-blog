<h1 id="处理响应-header">处理响应 header</h1>

<h2 id="需求分析">需求分析</h2>

<p>我们通过 <code class="language-plaintext highlighter-rouge">XMLHttpRequest</code> 对象的 <code class="language-plaintext highlighter-rouge">getAllResponseHeaders</code> 方法获取到的值是如下一段字符串：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>date: Fri, 05 Apr 2019 12:40:49 GMT
etag: W/"d-Ssxx4FRxEutDLwo2+xkkxKc4y0k"
connection: keep-alive
x-powered-by: Express
content-length: 13
content-type: application/json; charset=utf-8
</code></pre></div></div>

<p>每一行都是以回车符和换行符 <code class="language-plaintext highlighter-rouge">\r\n</code> 结束，它们是每个 <code class="language-plaintext highlighter-rouge">header</code> 属性的分隔符。对于上面这串字符串，我们希望最终解析成一个对象结构：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="err">date:</span><span class="w"> </span><span class="err">'Fri</span><span class="p">,</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="err">Apr</span><span class="w"> </span><span class="mi">2019</span><span class="w"> </span><span class="mi">12</span><span class="err">:</span><span class="mi">40</span><span class="err">:</span><span class="mi">49</span><span class="w"> </span><span class="err">GMT'</span><span class="w">
  </span><span class="err">etag:</span><span class="w"> </span><span class="err">'W/</span><span class="s2">"d-Ssxx4FRxEutDLwo2+xkkxKc4y0k"</span><span class="err">'</span><span class="p">,</span><span class="w">
  </span><span class="err">connection:</span><span class="w"> </span><span class="err">'keep-alive'</span><span class="p">,</span><span class="w">
  </span><span class="err">'x-powered-by':</span><span class="w"> </span><span class="err">'Express'</span><span class="p">,</span><span class="w">
  </span><span class="err">'content-length':</span><span class="w"> </span><span class="err">'</span><span class="mi">13</span><span class="err">'</span><span class="w">
  </span><span class="err">'content-type':</span><span class="w"> </span><span class="err">'application/json;</span><span class="w"> </span><span class="err">charset=utf</span><span class="mi">-8</span><span class="err">'</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="parseheaders-函数实现及应用">parseHeaders 函数实现及应用</h2>

<p>根据需求分析，我们要实现一个 <code class="language-plaintext highlighter-rouge">parseHeaders</code> 工具函数。</p>

<p><code class="language-plaintext highlighter-rouge">helpers/headers.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">parseHeaders</span><span class="p">(</span><span class="nx">headers</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="kr">any</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">parsed</span>
  <span class="p">}</span>

  <span class="nx">headers</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="se">\r\n</span><span class="dl">'</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">line</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">]</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">val</span> <span class="o">=</span> <span class="nx">val</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="nx">parsed</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
  <span class="p">})</span>

  <span class="k">return</span> <span class="nx">parsed</span>
<span class="p">}</span>
</code></pre></div></div>
<p>然后我们使用这个工具函数：</p>

<p><code class="language-plaintext highlighter-rouge">xhr.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">responseHeaders</span> <span class="o">=</span> <span class="nx">parseHeaders</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">getAllResponseHeaders</span><span class="p">())</span>
</code></pre></div></div>

<p>接着我们再去看刚才的 demo，发现我们已经把响应的 <code class="language-plaintext highlighter-rouge">headers</code> 字段从字符串解析成对象结构了。那么接下来，我们在解决之前遗留的第二个问题：对响应 <code class="language-plaintext highlighter-rouge">data</code> 字段的处理。</p>
