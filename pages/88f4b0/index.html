<h1 id="07-列表--key">07. 列表 &amp; Key</h1>

<p>如下代码，我们使用 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map"><code class="language-plaintext highlighter-rouge">map()</code></a> 函数让数组中的每一项变双倍，然后我们得到了一个新的列表 <code class="language-plaintext highlighter-rouge">doubled</code> 并打印出来：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">];</span>
<span class="kd">const</span> <span class="nx">doubled</span> <span class="o">=</span> <span class="nx">numbers</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">number</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">doubled</span><span class="p">);</span>
</code></pre></div></div>

<p>在 React 中，把数组转化为<a href="https://zh-hans.reactjs.org/docs/rendering-elements.html">元素</a>列表的过程是相似的。</p>

<h2 id="渲染多个组件">渲染多个组件</h2>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="c1">// 通过map方法将数值放入li，形成一个li标签组成的数值，在一次性放入ul</span>
<span class="kd">const</span> <span class="nx">listItems</span> <span class="o">=</span> <span class="nx">numbers</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">number</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">numbers</span><span class="p">}&lt;</span><span class="err">/</span><span class="na">li</span><span class="p">&gt;</span>
})

ReactDOM.render(
	<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">listItems</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  document.getElementById('root')
)
</code></pre></div></div>

<h2 id="基础列表组件">基础列表组件</h2>

<p>将列表组合成一个组件：</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">NumberList</span><span class="p">(</span><span class="nx">props</span><span class="p">){</span>
  <span class="kd">const</span> <span class="nx">numbers</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">numbers</span>
  <span class="kd">const</span> <span class="nx">listItems</span> <span class="o">=</span> <span class="nx">numbers</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">number</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// 记得给列表元素添加key</span>
    <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">number</span><span class="p">.</span><span class="nx">toString</span><span class="p">()}</span><span class="o">&gt;</span>
    	<span class="p">{</span><span class="nx">number</span><span class="p">}</span>
    <span class="p">&lt;</span><span class="err">/</span><span class="na">li</span><span class="p">&gt;</span>
  })

  return (
  	<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">listItems</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  )
}

const numbers = [1,2,3]
ReactDOM.render(
	<span class="p">&lt;</span><span class="nc">NumberList</span> <span class="na">numbers</span><span class="p">=</span><span class="si">{</span><span class="nx">numbers</span><span class="si">}</span> <span class="p">/&gt;</span>,
  document.getElementById('root')
)
</code></pre></div></div>

<h2 id="key">key</h2>

<p><strong>key 帮助 React 识别哪些元素改变了</strong>，比如被添加或删除。因此你应当给数组中的每一个元素赋予一个确定的标识。</p>

<p>一个元素的 key 最好是这个元素在列表中拥有的<strong>一个独一无二的字符串</strong>。<strong>通常，我们使用数据中的 id 来作为元素的 key</strong></p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">todoItems</span> <span class="o">=</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">todo</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="p">&lt;</span><span class="nt">li</span> <span class="na">key</span><span class="p">=</span><span class="si">{</span><span class="nx">todo</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="p">&gt;</span>
       <span class="si">{</span><span class="nx">todo</span><span class="p">.</span><span class="nx">text</span><span class="si">}</span>
  <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">);</span>
</code></pre></div></div>

<p>当元素没有确定 id 的时候，<strong>万不得已你可以使用元素索引 index 作为 key</strong>：</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">todoItems</span> <span class="o">=</span> <span class="nx">todos</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="c1">// 只有item中没有id 才用index代替</span>
  <span class="p">&lt;</span><span class="nt">li</span> <span class="na">key</span><span class="p">=</span><span class="si">{</span><span class="nx">index</span><span class="si">}</span><span class="p">&gt;</span>
        <span class="si">{</span><span class="nx">item</span><span class="p">.</span><span class="nx">text</span><span class="si">}</span>
  <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">);</span>
</code></pre></div></div>

<p><strong>如果列表项目的顺序可能会变化，我们不建议使用索引来用作 key 值，因为这样做会导致性能变差，还可能引起组件状态的问题。</strong></p>

<p>如果你选择不指定显式的 key 值，那么 React 将默认使用索引用作为列表项目的 key 值</p>

<h2 id="用-key-提取组件-在map方法内设置key">用 key 提取组件 (在map方法内设置key)</h2>

<p>元素的 key 只有放在就近的数组上下文中才有意义。</p>

<p><strong>例子：不正确的使用 key 的方式</strong></p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">ListItem</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="c1">// 错误！你不需要在这里指定 key：</span>
    <span class="p">&lt;</span><span class="nt">li</span> <span class="na">key</span><span class="p">=</span><span class="si">{</span><span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span><span class="p">&gt;</span>
      <span class="si">{</span><span class="nx">value</span><span class="si">}</span>
    <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">NumberList</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">numbers</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">numbers</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">listItems</span> <span class="o">=</span> <span class="nx">numbers</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">number</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="c1">// 错误！元素的 key 应该在这里指定：</span>
    <span class="p">&lt;</span><span class="nc">ListItem</span> <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="nx">number</span><span class="si">}</span> <span class="p">/&gt;</span>
  <span class="p">);</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="si">{</span><span class="nx">listItems</span><span class="si">}</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">];</span>
<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
  <span class="p">&lt;</span><span class="nc">NumberList</span> <span class="na">numbers</span><span class="p">=</span><span class="si">{</span><span class="nx">numbers</span><span class="si">}</span> <span class="p">/&gt;,</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">root</span><span class="dl">'</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<p>一个好的经验法则是：<strong>在 <code class="language-plaintext highlighter-rouge">map()</code> 方法中的元素需要设置 key 属性</strong>。</p>

<p>##</p>

<h2 id="key-只是在兄弟节点之间必须唯一">key 只是在兄弟节点之间必须唯一</h2>

<p>数组元素中使用的 key 在其兄弟节点之间应该是独一无二的。然而，它们<strong>不需要是全局唯一的</strong>。当我们生成两个不同的数组时，我们可以使用相同的 key 值。</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">Blog</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">sidebar</span> <span class="o">=</span> <span class="p">(</span>    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="si">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">post</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="p">&lt;</span><span class="nt">li</span> <span class="na">key</span><span class="p">=</span><span class="si">{</span><span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="p">&gt;</span>          <span class="si">{</span><span class="nx">post</span><span class="p">.</span><span class="nx">title</span><span class="si">}</span>
        <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
      <span class="p">)</span><span class="si">}</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">);</span>
  <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">post</span><span class="p">)</span> <span class="o">=&gt;</span>    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">key</span><span class="p">=</span><span class="si">{</span><span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="p">&gt;</span>      <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">post</span><span class="p">.</span><span class="nx">title</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">post</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="si">{</span><span class="nx">sidebar</span><span class="si">}</span>      <span class="p">&lt;</span><span class="nt">hr</span> <span class="p">/&gt;</span>
      <span class="si">{</span><span class="nx">content</span><span class="si">}</span>    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">posts</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Hello World</span><span class="dl">'</span><span class="p">,</span> <span class="na">content</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Welcome to learning React!</span><span class="dl">'</span><span class="p">},</span>
  <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Installation</span><span class="dl">'</span><span class="p">,</span> <span class="na">content</span><span class="p">:</span> <span class="dl">'</span><span class="s1">You can install React from npm.</span><span class="dl">'</span><span class="p">}</span>
<span class="p">];</span>
<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
  <span class="p">&lt;</span><span class="nc">Blog</span> <span class="na">posts</span><span class="p">=</span><span class="si">{</span><span class="nx">posts</span><span class="si">}</span> <span class="p">/&gt;,</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">root</span><span class="dl">'</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<h3 id="不能用key当props名传给子组件">不能用<code class="language-plaintext highlighter-rouge">key</code>当props名传给子组件</h3>

<p>key 会传递信息给 React ，但不会传递给你的组件。如果你的组件中需要使用 <code class="language-plaintext highlighter-rouge">key</code> 属性的值，请用其他属性名显式传递这个值：</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">posts</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">post</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="p">&lt;</span><span class="nc">Post</span>
    <span class="na">key</span><span class="p">=</span><span class="si">{</span><span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span>
    <span class="na">id</span><span class="p">=</span><span class="si">{</span><span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span>
    <span class="na">title</span><span class="p">=</span><span class="si">{</span><span class="nx">post</span><span class="p">.</span><span class="nx">title</span><span class="si">}</span> <span class="p">/&gt;</span>
<span class="p">);</span>
</code></pre></div></div>

<p>上面例子中，<code class="language-plaintext highlighter-rouge">Post</code> 组件可以读出 <code class="language-plaintext highlighter-rouge">props.id</code>，但是<strong>不能读出 <code class="language-plaintext highlighter-rouge">props.key</code></strong>。</p>

<h2 id="在-jsx-中嵌入-map">在 JSX 中嵌入 map()</h2>

<p>JSX 允许在大括号中<a href="https://zh-hans.reactjs.org/docs/introducing-jsx.html#embedding-expressions-in-jsx">嵌入任何表达式</a>，所以我们可以内联 <code class="language-plaintext highlighter-rouge">map()</code> 返回的结果：</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">NumberList</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">numbers</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">numbers</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="si">{</span>
        <span class="nx">numbers</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">number</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="p">&lt;</span><span class="nc">ListItem</span> <span class="na">key</span><span class="p">=</span><span class="si">{</span><span class="nx">number</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span> <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="nx">number</span><span class="si">}</span> <span class="p">/&gt;</span>
        <span class="p">)</span>
      <span class="si">}</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这么做有时可以使你的代码更清晰，但有时这种风格也会被滥用。</p>

<p>就像在 JavaScript 中一样，何时需要为了可读性提取出一个变量，这完全取决于你。但请记住，如果一个 <code class="language-plaintext highlighter-rouge">map()</code> 嵌套了太多层级，那可能就是你<a href="https://zh-hans.reactjs.org/docs/components-and-props.html#extracting-components">提取组件</a>的一个好时机。</p>
