<h2 id="策略模式">策略模式</h2>
<h3 id="什么是策略模式">什么是策略模式</h3>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">策略模式</code>是一种行为设计模式，定义一系列算法，将每一个算法封装起来，并让它们可以相互替换；</p>
</blockquote>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">策略模式</code>让算法独立于使用它的客户而变化，也称为政策模式（Policy）；</p>
</blockquote>

<h3 id="使用策略模式计算绩效奖金">使用策略模式计算绩效奖金</h3>

<p>很多公司的年终跟绩效挂钩：绩效为<code class="language-plaintext highlighter-rouge">S</code>的是2倍工资、绩效为<code class="language-plaintext highlighter-rouge">A</code>的为1.5倍工资、绩效为<code class="language-plaintext highlighter-rouge">B</code>的为1.2倍工资；
假设我们的财务需要一段代码方便计算年终奖；</p>

<h4 id="最初的代码">最初的代码</h4>

<p>我们可以通过编写一个名为<code class="language-plaintext highlighter-rouge">calculateBonus</code>的函数来计算每一个人的奖金数额；
很显然<code class="language-plaintext highlighter-rouge">calculateBonus</code>函数要正常工作责需要接受两个参数：基本工资和和绩效考核等级；</p>

<p>代码如下：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">calculateBonus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">salary</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">S</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">salary</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">A</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">salary</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">B</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">salary</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">calculateBonus</span><span class="p">(</span><span class="dl">'</span><span class="s1">S</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
<span class="c1">// 输出 2000</span>
<span class="nx">calculateBonus</span><span class="p">(</span><span class="dl">'</span><span class="s1">A</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
<span class="c1">// 输出 1500</span>
</code></pre></div></div>
<p>可以发现，这段代码很简单，但是存在的显而易见的缺点</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">calculateBonus</code>函数比较庞大，包含了很多<code class="language-plaintext highlighter-rouge">if-else</code>语句，这些语句需要覆盖所有的逻辑分支；</li>
  <li><code class="language-plaintext highlighter-rouge">calculateBonus</code>函数缺乏弹性，如果增加了一种新的绩效等级<code class="language-plaintext highlighter-rouge">C</code>,或则想把绩效为<code class="language-plaintext highlighter-rouge">S</code>的奖金系数改为2.5，那么我们必须深入<code class="language-plaintext highlighter-rouge">calculateBonus</code>函数内部的实现，这是违反<code class="language-plaintext highlighter-rouge">开放-封闭原则</code>的；</li>
  <li>算法的复用逻辑性差，如果在程序的其他地方需要重用这些计算逻辑，我们只能<code class="language-plaintext highlighter-rouge">ctrl+c</code>和<code class="language-plaintext highlighter-rouge">ctrl+v</code>;</li>
</ul>

<blockquote>
  <p>开放-封闭原则: 对拓展开放、对修改关闭，用最少的代码，甚至不用代码修改原来的逻辑，只要添加新的扩展逻辑代码；</p>
</blockquote>

<p>因此我们需要重构一下代码；</p>

<h4 id="一轮修改后代码">一轮修改后代码</h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">performanceS</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">salary</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">salary</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">performanceA</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">salary</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">salary</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">performanceB</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">salary</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">salary</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">calculateBonus</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">level</span> <span class="nx">salary</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">S</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">performanceS</span><span class="p">(</span><span class="nx">salary</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">A</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">performanceA</span><span class="p">(</span><span class="nx">salary</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">B</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">performanceB</span><span class="p">(</span><span class="nx">salary</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">calculateBonus</span><span class="p">(</span><span class="dl">'</span><span class="s1">S</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
<span class="c1">// 输出 2000</span>
</code></pre></div></div>

<p>目前我们的程序得到了一定的改善，但是这种改善非常有限，我们依然没有解决最重要的问题：<code class="language-plaintext highlighter-rouge">calculateBonus</code>函数可能越来越庞大，而且在系统变化的时候缺乏弹性；</p>

<p>其实使用这些 if-else 的目的就是为了对应状态和计算方式。
<img src="https://cdn.jsdelivr.net/gh/maoyln/maoyl-img/blog/20220812-strategy.png" alt="" /></p>

<h4 id="使用策略模式重构代码">使用策略模式重构代码</h4>

<p>因为该文章写的是<code class="language-plaintext highlighter-rouge">策略模式</code>,显而易见，我们将要用<code class="language-plaintext highlighter-rouge">策略模式</code>对上述代码进行重构；</p>

<blockquote>
  <p>将不变的和变化的部分隔开是每一个设计模式的主题，策略模式也不例外；
<strong>策略模式</strong>的目的就是将算法的使用和算法的实现分离开来；</p>
</blockquote>

<p>在这里例子里：算法的使用方式是不变的，而算法的实现是变化的；</p>

<blockquote>
  <p>一个基于策略模式的程序，必须有两部分组成：
第一部分：是一组策略类，策略类中封装了具体的算法过程
第二部分：环境类<code class="language-plaintext highlighter-rouge">Content</code>,它可以接受客户请求，然后把请求委托给策略类；</p>
</blockquote>

<p>模拟面向对象例子</p>

<p>策略对象:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">const</span> <span class="nx">performanceS</span>  <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span>
    <span class="nx">performanceS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">calculate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">salary</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">salary</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">performanceA</span>  <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span>
    <span class="nx">performanceA</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">calculate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">salary</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">salary</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">performanceB</span>  <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span>
    <span class="nx">performanceB</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">calculate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">salary</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">salary</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>下面定义Bonus:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">const</span> <span class="nx">Bonus</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">salary</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// 原始工资</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">stringify</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// 绩效等级对应的策略对象</span>
    <span class="p">}</span>

    <span class="nx">Bonus</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setSalary</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">salary</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">salary</span> <span class="o">=</span> <span class="nx">salary</span><span class="p">;</span> <span class="c1">// 设置原始工资</span>
    <span class="p">}</span>
    <span class="nx">Bonus</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setStringify</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">stringify</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">stringify</span> <span class="o">=</span> <span class="nx">stringify</span><span class="p">;</span> <span class="c1">// 设置员工绩效等级对应的策略对象</span>
    <span class="p">}</span>

    <span class="nx">Bonus</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getBonus</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">stringify</span><span class="p">.</span><span class="nx">calculate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">salary</span><span class="p">);</span> <span class="c1">// 把计算奖金的操作委托给策略对象</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>使用：</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">const</span> <span class="nx">bonus</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Bonus</span><span class="p">();</span>
    <span class="nx">bonus</span><span class="p">.</span><span class="nx">setSalary</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
    <span class="nx">bonus</span><span class="p">.</span><span class="nx">setStringify</span><span class="p">(</span><span class="k">new</span> <span class="nx">performanceS</span><span class="p">);</span> <span class="c1">// 设置策略对象</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">bonus</span><span class="p">.</span><span class="nx">getBonus</span><span class="p">());</span> <span class="c1">// 输出 2000</span>

    <span class="nx">bonus</span><span class="p">.</span><span class="nx">setStringify</span><span class="p">(</span><span class="k">new</span> <span class="nx">performanceA</span><span class="p">);</span> <span class="c1">// 设置策略对象</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">bonus</span><span class="p">.</span><span class="nx">getBonus</span><span class="p">());</span> <span class="c1">// 输出 1500</span>

</code></pre></div></div>

<p>上述代码，看着比较繁琐对吧，因为上面代码是基于传统面向对象语言的模仿；
实际在<code class="language-plaintext highlighter-rouge">javascript</code>语言中，函数也是对象，所以我们有更简单和直接的方法是把<code class="language-plaintext highlighter-rouge">strategy</code>直接定义为函数；</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">strategies</span> <span class="o">=</span>  <span class="p">{</span>
    <span class="dl">'</span><span class="s1">S</span><span class="dl">'</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">salary</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">salary</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="dl">'</span><span class="s1">A</span><span class="dl">'</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">salary</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">salary</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="dl">'</span><span class="s1">B</span><span class="dl">'</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">salary</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">salary</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">;</span>
    <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<p>同样，<code class="language-plaintext highlighter-rouge">Context</code>也没有必要用到<code class="language-plaintext highlighter-rouge">Bonus</code>类来表示，我们依然用<code class="language-plaintext highlighter-rouge">calculateBonus</code>函数充当<code class="language-plaintext highlighter-rouge">Context</code>来接受用户请求; 经过改造，代码结构变得更加简洁：</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">const</span> <span class="nx">calculateBonus</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">salary</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">strategies</span><span class="p">[</span><span class="nx">level</span><span class="p">](</span><span class="nx">salary</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">calculateBonus</span><span class="p">(</span><span class="dl">'</span><span class="s1">S</span><span class="dl">'</span><span class="p">,</span> <span class="mi">1000</span><span class="p">));</span> <span class="c1">// 输出2000</span>
</code></pre></div></div>

<p>es6类实现</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//接下来定义奖金类Bonus：</span>
<span class="kd">class</span> <span class="nx">Bonus</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">salary</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// 原始工资</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">strategy</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// 绩效等级对应的策略对象</span>
  <span class="p">}</span>
  <span class="nx">setSalary</span><span class="p">(</span><span class="nx">salary</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">salary</span> <span class="o">=</span> <span class="nx">salary</span><span class="p">;</span> <span class="c1">// 设置员工的原始工资</span>
  <span class="p">}</span>
  <span class="nx">setStrategy</span><span class="p">(</span><span class="nx">strategy</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">strategy</span> <span class="o">=</span> <span class="nx">strategy</span><span class="p">;</span> <span class="c1">// 设置员工绩效等级对应的策略对象</span>
  <span class="p">}</span>
  <span class="nx">getBonus</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// 取得奖金数额</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">strategy</span><span class="p">.</span><span class="nx">calculate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">salary</span><span class="p">);</span> <span class="c1">// 把计算奖金的操作委托给对应的策略对象</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">bonus</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Bonus</span><span class="p">();</span>
<span class="nx">bonus</span><span class="p">.</span><span class="nx">setSalary</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

<span class="nx">bonus</span><span class="p">.</span><span class="nx">setStrategy</span><span class="p">(</span><span class="k">new</span> <span class="nx">performanceS</span><span class="p">());</span> <span class="c1">// 设置策略对象</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">bonus</span><span class="p">.</span><span class="nx">getBonus</span><span class="p">());</span> <span class="c1">// 输出：2000</span>

<span class="nx">bonus</span><span class="p">.</span><span class="nx">setStrategy</span><span class="p">(</span><span class="k">new</span> <span class="nx">performanceA</span><span class="p">());</span> <span class="c1">// 设置策略对象</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">bonus</span><span class="p">.</span><span class="nx">getBonus</span><span class="p">());</span> <span class="c1">// 输出：1500</span>

</code></pre></div></div>

<h4 id="总结">总结</h4>

<p>看到这里，我们对策略模式有了大致了解，下面我们总结一下，</p>
<h5 id="流程图比较">流程图比较</h5>
<ul>
  <li>
    <p>之前的代码逻辑
<img src="https://cdn.jsdelivr.net/gh/maoyln/maoyl-img/blog/20220812-strategy-0101.png" alt="" /></p>
  </li>
  <li>
    <p>优化后的代码逻辑
<img src="https://cdn.jsdelivr.net/gh/maoyln/maoyl-img/blog/20220812-strategy-02.png" alt="" /></p>
  </li>
</ul>

<p>以上的优化策略就是使用了设计模式之策略模式，在实际的项目开发过程中还是比较实用。</p>

<h5 id="优缺点">优缺点</h5>
<blockquote>
  <p>优点</p>
</blockquote>

<ul>
  <li>策略模式利用组合、委托和多态等技术和思想，可以有效地避免多重条件选择语句。</li>
  <li>策略模式提供了对开放—封闭原则的完美支持，将算法封装在独立的strategy中，使得它们易于切换，易于理解，易于扩展。</li>
  <li>策略模式中的算法也可以复用在系统的其他地方，从而避免许多重复的复制粘贴工作。</li>
  <li>在策略模式中利用组合和委托来让 Context 拥有执行算法的能力，这也是继承的一种更轻便的替代方案。</li>
</ul>

<blockquote>
  <p>缺点</p>
</blockquote>

<ul>
  <li>增加许多策略类或者策略对象，但实际上这比把它们负责的 逻辑堆砌在 Context 中要好。</li>
  <li>要使用策略模式，必须了解所有的 strategy，必须了解各个 strategy 之间的不同点， 这样才能选择一个合适的 strategy。</li>
</ul>

<h5 id="使用场景">使用场景</h5>

<p>在什么情况下可以考虑使用策略模式呢？如果函数具有以下特征：</p>
<ul>
  <li>判断条件很多</li>
  <li>各个判断条件下的代码相互独立</li>
</ul>

<p>然后可以将每个判断条件下的代码封装成一个独立的函数，然后建立判断条件和具体策略的映射关系。</p>

<h3 id="拓展">拓展</h3>
<h4 id="多态在策略模式中的体现">多态在策略模式中的体现</h4>

<p>通过使用策略模式的重构代码，我们消除了原程序中大片的条件分支语句；
所有跟计算逻辑不相关的不放在<code class="language-plaintext highlighter-rouge">Context</code>中，而是分布在各个策略对象中；
<code class="language-plaintext highlighter-rouge">Context</code>并没有计算能力，而是把这个职责委托给某个策略对象；
每个策略对象负责的算法已被各个自封在对象内部；
当我们对这些策略对象发出<code class="language-plaintext highlighter-rouge">计算奖金</code>的请求时，他们会返回各自不同的结果；
这正是<code class="language-plaintext highlighter-rouge">多态</code>的体现，也是<code class="language-plaintext highlighter-rouge">他们可以相互替换</code>的目的；
替换<code class="language-plaintext highlighter-rouge">Content</code>中当前保存的策略对象，便能执行不同的算法来得到我们想要的结果；</p>

<h4 id="小事例出自javascript设计模式与开发实践">小事例（出自《JavaScript设计模式与开发实践》）</h4>

<h4 id="缓动动画">缓动动画</h4>

<blockquote>
  <p>目标：编写一个动画类和一些缓动算法，让小球以各种各样的缓动效果在页面中运动</p>
</blockquote>

<blockquote>
  <p>分析：
首先缓动算法的职责是实现小球如何运动
然后动画类（即context）的职责是负责：</p>
</blockquote>

<ul>
  <li>初始化动画对象
    <ul>
      <li>
        <p>在运动开始之前，需要提前记录一些有用的信息，至少包括以下信息:</p>

        <ul>
          <li>动画开始时的准确时间点;</li>
          <li>动画开始时，小球所在的原始位置;</li>
          <li>小球移动的目标位置;</li>
          <li>小球运动持续的时间。</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>计算小球某时刻的位置</li>
  <li>更新小球的位置</li>
</ul>

<p>::: demo [vanilla]</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"demo-container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"box"</span> <span class="na">id=</span><span class="s">"div"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ring1"</span><span class="nt">&gt;&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ring2"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;script&gt;</span>
    <span class="kd">var</span> <span class="nx">tween</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">linear</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">c</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">/</span> <span class="nx">d</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="na">easeIn</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">c</span> <span class="o">*</span> <span class="p">(</span><span class="nx">t</span> <span class="o">/=</span> <span class="nx">d</span><span class="p">)</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="na">strongEaseIn</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">c</span> <span class="o">*</span> <span class="p">(</span><span class="nx">t</span> <span class="o">/=</span> <span class="nx">d</span><span class="p">)</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="na">strongEaseOut</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">c</span> <span class="o">*</span> <span class="p">((</span><span class="nx">t</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">/</span> <span class="nx">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="na">sineaseIn</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">c</span> <span class="o">*</span> <span class="p">(</span><span class="nx">t</span> <span class="o">/=</span> <span class="nx">d</span><span class="p">)</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="na">sineaseOut</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">c</span> <span class="o">*</span> <span class="p">((</span><span class="nx">t</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">/</span> <span class="nx">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">Animate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">dom</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">dom</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">;</span> <span class="c1">// 进行运动的dom 节点</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">startTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 动画开始时间</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">startPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 动画开始时，dom 节点的位置，即dom 的初始位置</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">endPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 动画结束时，dom 节点的位置，即dom 的目标位置</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">propertyName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// dom 节点需要被改变的css 属性名</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">easing</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// 缓动算法</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// 动画持续时间</span>
    <span class="p">};</span>


    <span class="nx">Animate</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">propertyName</span><span class="p">,</span> <span class="nx">endPos</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">easing</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">startTime</span> <span class="o">=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">;</span> <span class="c1">// 动画启动时间</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">startPos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">()[</span><span class="nx">propertyName</span><span class="p">];</span> <span class="c1">// dom 节点初始位置</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">propertyName</span> <span class="o">=</span> <span class="nx">propertyName</span><span class="p">;</span> <span class="c1">// dom 节点需要被改变的CSS 属性名</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">endPos</span> <span class="o">=</span> <span class="nx">endPos</span><span class="p">;</span> <span class="c1">// dom 节点目标位置</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="nx">duration</span><span class="p">;</span> <span class="c1">// 动画持续事件</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">easing</span> <span class="o">=</span> <span class="nx">tween</span><span class="p">[</span><span class="nx">easing</span><span class="p">];</span> <span class="c1">// 缓动算法</span>
        <span class="kd">var</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">timeId</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="c1">// 启动定时器，开始执行动画</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">step</span><span class="p">()</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 如果动画已结束，则清除定时器</span>
            <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">timeId</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="p">},</span> <span class="mi">16</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">Animate</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">step</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">;</span> <span class="c1">// 取得当前时间</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">startTime</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">duration</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// (1)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">endPos</span><span class="p">);</span> <span class="c1">// 更新小球的CSS 属性值</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">easing</span><span class="p">(</span><span class="nx">t</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">startTime</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">startPos</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">endPos</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">startPos</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">duration</span><span class="p">);</span>
        <span class="c1">// pos 为小球当前位置</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span> <span class="c1">// 更新小球的CSS 属性值</span>
    <span class="p">};</span>

    <span class="nx">Animate</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pos</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">px</span><span class="dl">'</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">div</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">animate</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Animate</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
    <span class="nx">setInterval</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// animate.start('left', 0, 1500, 'linear');</span>
        <span class="c1">//   animate.start( 'left', 0, 1500, 'easeIn');</span>
        <span class="c1">//   animate.start( 'left', 0, 1500, 'strongEaseIn');</span>
        <span class="c1">//   animate.start( 'left', 0, 1500, 'strongEaseOut');</span>
        <span class="c1">//   animate.start( 'left', 0, 1500, 'sineaseIn');</span>
          <span class="nx">animate</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span> <span class="dl">'</span><span class="s1">left</span><span class="dl">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="dl">'</span><span class="s1">sineaseOut</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">},</span> <span class="mi">1600</span><span class="p">);</span>
    <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;style&gt;</span>
        <span class="nc">.demo-container</span> <span class="p">{</span>
            <span class="nl">width</span><span class="p">:</span><span class="m">30vw</span><span class="p">;</span>
            <span class="nl">height</span><span class="p">:</span><span class="m">20px</span><span class="p">;</span>          
        <span class="p">}</span>
  
        <span class="nc">.box</span> <span class="p">{</span>
            <span class="nl">position</span><span class="p">:</span><span class="nb">absolute</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nc">.ring1</span> <span class="p">{</span>
            <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span>
            <span class="nl">top</span><span class="p">:</span> <span class="m">50%</span><span class="p">;</span>
            <span class="nl">left</span><span class="p">:</span> <span class="m">50%</span><span class="p">;</span>
            <span class="nl">transform</span><span class="p">:</span> <span class="n">translate</span><span class="p">(</span><span class="m">-50%</span><span class="p">,</span> <span class="m">-50%</span><span class="p">);</span>
            <span class="nl">width</span><span class="p">:</span> <span class="m">16px</span><span class="p">;</span>
            <span class="nl">height</span><span class="p">:</span> <span class="m">16px</span><span class="p">;</span>
            <span class="nl">border-radius</span><span class="p">:</span> <span class="m">50%</span><span class="p">;</span>
            <span class="nl">animation</span><span class="p">:</span> <span class="n">mark-ring1-animation</span> <span class="m">2s</span> <span class="n">infinite</span><span class="p">;</span>
            <span class="nl">background-color</span><span class="p">:</span> <span class="nb">rgb</span><span class="p">(</span><span class="m">255</span><span class="p">,</span> <span class="m">159</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nc">.ring2</span> <span class="p">{</span>
            <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span>
            <span class="nl">top</span><span class="p">:</span> <span class="m">50%</span><span class="p">;</span>
            <span class="nl">left</span><span class="p">:</span> <span class="m">50%</span><span class="p">;</span>
            <span class="nl">transform</span><span class="p">:</span> <span class="n">translate</span><span class="p">(</span><span class="m">-50%</span><span class="p">,</span> <span class="m">-50%</span><span class="p">);</span>
            <span class="nl">width</span><span class="p">:</span> <span class="m">32px</span><span class="p">;</span>
            <span class="nl">height</span><span class="p">:</span> <span class="m">32px</span><span class="p">;</span>
            <span class="nl">border-radius</span><span class="p">:</span> <span class="m">50%</span><span class="p">;</span>
            <span class="nl">animation</span><span class="p">:</span> <span class="n">mark-ring2-animation</span> <span class="m">2s</span> <span class="n">infinite</span><span class="p">;</span>  
            <span class="nl">background-color</span><span class="p">:</span> <span class="nb">rgb</span><span class="p">(</span><span class="m">255</span><span class="p">,</span> <span class="m">159</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">@keyframes</span> <span class="n">mark-ring1-animation</span> <span class="p">{</span>
            <span class="err">0</span><span class="o">%</span> <span class="p">{</span>
                <span class="nl">width</span><span class="p">:</span> <span class="m">16px</span><span class="p">;</span>
                <span class="nl">height</span><span class="p">:</span> <span class="m">16px</span><span class="p">;</span>
                <span class="nl">opacity</span><span class="p">:</span> <span class="m">1</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="err">100</span><span class="o">%</span> <span class="p">{</span>
                <span class="nl">width</span><span class="p">:</span> <span class="m">32px</span><span class="p">;</span>
                <span class="nl">height</span><span class="p">:</span> <span class="m">32px</span><span class="p">;</span>
                <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.5</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">@keyframes</span> <span class="n">mark-ring2-animation</span> <span class="p">{</span>
            <span class="err">0</span><span class="o">%</span> <span class="p">{</span>
                <span class="nl">width</span><span class="p">:</span> <span class="m">32px</span><span class="p">;</span>
                <span class="nl">height</span><span class="p">:</span> <span class="m">32px</span><span class="p">;</span>
                <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.5</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="err">100</span><span class="o">%</span> <span class="p">{</span>
                <span class="nl">width</span><span class="p">:</span> <span class="m">50px</span><span class="p">;</span>
                <span class="nl">height</span><span class="p">:</span> <span class="m">50px</span><span class="p">;</span>
                <span class="nl">opacity</span><span class="p">:</span> <span class="m">0.3</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
<p>:::</p>

