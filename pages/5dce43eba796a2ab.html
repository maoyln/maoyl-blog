<h1 id="withcredentials">withCredentials</h1>

<h2 id="需求分析">需求分析</h2>

<p>有些时候我们会发一些跨域请求，比如 <code class="language-plaintext highlighter-rouge">http://domain-a.com</code> 站点发送一个 <code class="language-plaintext highlighter-rouge">http://api.domain-b.com/get</code> 的请求，默认情况下，浏览器会根据同源策略限制这种跨域请求，但是可以通过 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a> 技术解决跨域问题。</p>

<p>在同域的情况下，我们发送请求会默认携带当前域下的 cookie，但是在跨域的情况下，默认是不会携带请求域下的 cookie 的，比如 <code class="language-plaintext highlighter-rouge">http://domain-a.com</code> 站点发送一个 <code class="language-plaintext highlighter-rouge">http://api.domain-b.com/get</code> 的请求，默认是不会携带 <code class="language-plaintext highlighter-rouge">api.domain-b.com</code> 域下的 cookie，如果我们想携带（很多情况下是需要的），只需要设置请求的 <code class="language-plaintext highlighter-rouge">xhr</code> 对象的 <code class="language-plaintext highlighter-rouge">withCredentials</code> 为 true 即可。</p>

<h2 id="代码实现">代码实现</h2>

<p>先修改 <code class="language-plaintext highlighter-rouge">AxiosRequestConfig</code> 的类型定义。</p>

<p><code class="language-plaintext highlighter-rouge">types/index.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kr">interface</span> <span class="nx">AxiosRequestConfig</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nl">withCredentials</span><span class="p">?:</span> <span class="nx">boolean</span>
<span class="p">}</span>
</code></pre></div></div>

<p>然后修改请求发送前的逻辑。</p>

<p><code class="language-plaintext highlighter-rouge">core/xhr.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="cm">/*...*/</span> <span class="nx">withCredentials</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">config</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">withCredentials</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="demo-编写">demo 编写</h2>

<p>在 <code class="language-plaintext highlighter-rouge">examples</code> 目录下创建 <code class="language-plaintext highlighter-rouge">more</code> 目录，在 <code class="language-plaintext highlighter-rouge">cancel</code> 目录下创建 <code class="language-plaintext highlighter-rouge">index.html</code>:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>More example<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/__build__/more.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>接着创建 <code class="language-plaintext highlighter-rouge">app.ts</code> 作为入口文件：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../src/index</span><span class="dl">'</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">a=b</span><span class="dl">'</span>

<span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/more/get</span><span class="dl">'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://127.0.0.1:8088/more/server2</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="p">},</span> <span class="p">{</span>
  <span class="na">withCredentials</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>这次我们除了给 <code class="language-plaintext highlighter-rouge">server.js</code> 去配置了接口路由，还创建了 <code class="language-plaintext highlighter-rouge">server2.js</code>，起了一个跨域的服务。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">body-parser</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">cookieParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cookie-parser</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span> <span class="na">extended</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}))</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cookieParser</span><span class="p">())</span>

<span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">()</span>

<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="p">{</span>
  <span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:8080</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">Access-Control-Allow-Credentials</span><span class="dl">'</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">Access-Control-Allow-Methods</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST, GET, PUT, DELETE, OPTIONS</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">Access-Control-Allow-Headers</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span>
<span class="p">}</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/more/server2</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">cors</span><span class="p">)</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">options</span><span class="p">(</span><span class="dl">'</span><span class="s1">/more/server2</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">cors</span><span class="p">)</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
<span class="p">})</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">8088</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">)</span>
</code></pre></div></div>

<p>这里需要安装一下 <code class="language-plaintext highlighter-rouge">cookie-parser</code> 插件，用于请求发送的 cookie。</p>

<p>通过 demo 演示我们可以发现，对于同域请求，会携带 cookie，而对于跨域请求，只有我们配置了 <code class="language-plaintext highlighter-rouge">withCredentials</code> 为 true，才会携带 cookie。</p>

<p>至此我们的 <code class="language-plaintext highlighter-rouge">withCredentials</code> feature 开发完毕，下一节课我们来实现 axios 对 XSRF
 的防御功能。</p>
