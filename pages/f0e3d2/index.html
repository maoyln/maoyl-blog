<h1 id="09-状态提升-共享状态">09. 状态提升 (共享状态)</h1>

<p>通常，<strong>多个组件需要反映相同的变化数据，这时我们建议将共享状态提升到最近的共同父组件中去</strong>。</p>

<p>在 React 中，<strong>将多个组件中需要共享的 state 向上移动到它们的最近共同父组件中，便可实现共享 state。这就是所谓的“状态提升”</strong></p>

<p>两个输入框共享数据的例子：</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">scaleNames</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">c</span><span class="p">:</span> <span class="dl">'</span><span class="s1">摄氏度</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">f</span><span class="p">:</span> <span class="dl">'</span><span class="s1">华氏度</span><span class="dl">'</span>
<span class="p">};</span>

<span class="c1">// 转摄氏度</span>
<span class="kd">function</span> <span class="nx">toCelsius</span><span class="p">(</span><span class="nx">fahrenheit</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">fahrenheit</span> <span class="o">-</span> <span class="mi">32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">9</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 转华氏度</span>
<span class="kd">function</span> <span class="nx">toFahrenheit</span><span class="p">(</span><span class="nx">celsius</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">celsius</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 转换，为空时返回空，否则返回保留三位小数的浮点数</span>
<span class="kd">function</span> <span class="nx">tryConvert</span><span class="p">(</span><span class="nx">temperature</span><span class="p">,</span> <span class="nx">convert</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">temperature</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">Number</span><span class="p">.</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="dl">''</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="nx">convert</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
  <span class="c1">// Math.round返回一个数字四舍五入后的整数</span>
  <span class="kd">const</span> <span class="nx">rounded</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">output</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">rounded</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// 水是否会沸腾</span>
<span class="kd">function</span> <span class="nx">BoilingVerdict</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">props</span><span class="p">.</span><span class="nx">celsius</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>水会沸腾.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>水不会沸腾.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;;</span>
<span class="p">}</span>

<span class="c1">// 子组件 - 输入框</span>
<span class="kd">class</span> <span class="nx">TemperatureInput</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span> <span class="c1">// 接收父组件传入props</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">handleChange</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleChange</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="c1">// 绑定回调函数，并修正this</span>
  <span class="p">}</span>
	
  <span class="c1">// 处理change</span>
  <span class="nx">handleChange</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// e是合成事件对象，通过e.target.value 取值</span>
    <span class="c1">// 调用父组件传入的onTemperatureChange函数，并传值</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">onTemperatureChange</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    
    <span class="c1">// 当子组件输入框值改变时调用父组件的onTemperatureChange方法，并传出值。</span>
    <span class="c1">// 另外，onTemperatureChange命名方式：`在&lt;子组件&gt;变更`</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 接收父组件传入的温度值</span>
    <span class="kd">const</span> <span class="nx">temperature</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">temperature</span><span class="p">;</span>
    <span class="c1">// 接收父组件传入的衡量方式</span>
    <span class="kd">const</span> <span class="nx">scale</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">scale</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;</span>输入温度-<span class="si">{</span><span class="nx">scaleNames</span><span class="p">[</span><span class="nx">scale</span><span class="p">]</span><span class="si">}</span>:<span class="p">&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="nx">temperature</span><span class="si">}</span>
               <span class="na">onChange</span><span class="p">=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">handleChange</span><span class="si">}</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="c1">// 父组件 - 计算器</span>
<span class="kd">class</span> <span class="nx">Calculator</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span> <span class="c1">// 接收父组件传入props</span>
    
    <span class="c1">// 绑定事件回调，并修正this</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">handleCelsiusChange</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleCelsiusChange</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">handleFahrenheitChange</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleFahrenheitChange</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="c1">// 创建初始状态值</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span><span class="na">temperature</span><span class="p">:</span> <span class="dl">''</span><span class="p">,</span> <span class="na">scale</span><span class="p">:</span> <span class="dl">'</span><span class="s1">c</span><span class="dl">'</span><span class="p">};</span>
  <span class="p">}</span>
	
  <span class="c1">// 处理`摄氏度`变更</span>
  <span class="nx">handleCelsiusChange</span><span class="p">(</span><span class="nx">temperature</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// temperature接收到子组件传来的参数，并通过setState修改状态</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">scale</span><span class="p">:</span> <span class="dl">'</span><span class="s1">c</span><span class="dl">'</span><span class="p">,</span> <span class="nx">temperature</span><span class="p">});</span>
  <span class="p">}</span>
	
  <span class="c1">// 处理`华氏度`变更</span>
  <span class="nx">handleFahrenheitChange</span><span class="p">(</span><span class="nx">temperature</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// temperature接收到子组件传来的参数，并通过setState修改状态</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">scale</span><span class="p">:</span> <span class="dl">'</span><span class="s1">f</span><span class="dl">'</span><span class="p">,</span> <span class="nx">temperature</span><span class="p">});</span>
  <span class="p">}</span>
	
  <span class="c1">// 渲染函数（每当state改变都会调用）</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 取得当前state下的值</span>
    <span class="kd">const</span> <span class="nx">scale</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">scale</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">temperature</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">temperature</span><span class="p">;</span>
    
    <span class="c1">// 根据scale值取得相应的温度数据</span>
    <span class="kd">const</span> <span class="nx">celsius</span> <span class="o">=</span> <span class="nx">scale</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">f</span><span class="dl">'</span> <span class="p">?</span> <span class="nx">tryConvert</span><span class="p">(</span><span class="nx">temperature</span><span class="p">,</span> <span class="nx">toCelsius</span><span class="p">)</span> <span class="p">:</span> <span class="nx">temperature</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">fahrenheit</span> <span class="o">=</span> <span class="nx">scale</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">c</span><span class="dl">'</span> <span class="p">?</span> <span class="nx">tryConvert</span><span class="p">(</span><span class="nx">temperature</span><span class="p">,</span> <span class="nx">toFahrenheit</span><span class="p">)</span> <span class="p">:</span> <span class="nx">temperature</span><span class="p">;</span>
		
    <span class="c1">// 返回渲染的元素</span>
    <span class="c1">// 插入子组件TemperatureInput传入相应的参数，onTemperatureChange指定为当前组件的回调函数</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nc">TemperatureInput</span>
          <span class="na">scale</span><span class="p">=</span><span class="s">"c"</span>
          <span class="na">temperature</span><span class="p">=</span><span class="si">{</span><span class="nx">celsius</span><span class="si">}</span>
          <span class="na">onTemperatureChange</span><span class="p">=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">handleCelsiusChange</span><span class="si">}</span> <span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nc">TemperatureInput</span>
          <span class="na">scale</span><span class="p">=</span><span class="s">"f"</span>
          <span class="na">temperature</span><span class="p">=</span><span class="si">{</span><span class="nx">fahrenheit</span><span class="si">}</span>
          <span class="na">onTemperatureChange</span><span class="p">=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">handleFahrenheitChange</span><span class="si">}</span> <span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nc">BoilingVerdict</span>
          <span class="na">celsius</span><span class="p">=</span><span class="si">{</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">celsius</span><span class="p">)</span><span class="si">}</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 渲染DOM</span>
<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
  <span class="p">&lt;</span><span class="nc">Calculator</span> <span class="p">/&gt;,</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">root</span><span class="dl">'</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<p><a href="https://codepen.io/gaearon/pen/WZpxpz?editors=0010"><strong>在 CodePen 上尝试</strong></a></p>

<p>::: note</p>
<ol>
  <li>父组件给所有子组件传入state的值</li>
  <li>子组件修改值时调用父组件的方法并把值传出</li>
  <li>父组件接收到值之后修改state</li>
  <li>state被修改之后重新执行render函数，并回到第1步
:::</li>
</ol>

<h3 id="小结">小结</h3>

<ul>
  <li>任何可变数据应当只有一个相对应的唯一“数据源”
    <ul>
      <li>通常，state 都是首先添加到需要渲染数据的组件中去</li>
      <li>然后，如果其他组件也需要这个 state，那么你可以将它提升至这些组件的最近共同父组件中</li>
      <li>你应当依靠<a href="https://zh-hans.reactjs.org/docs/state-and-lifecycle.html#the-data-flows-down">自上而下的数据流</a>，而不是尝试在不同组件间同步 state。</li>
    </ul>
  </li>
  <li>
    <p>“存在”于组件中的任何 state，仅有组件自己能够修改它</p>
  </li>
  <li>如果某些数据可以由 props 或 state 推导得出，那么它就不应该存在于 state 中。（如上例中，经过tryConvert方法转换的后的值。）</li>
</ul>

<h3 id="react开发者工具debug">React开发者工具（debug）</h3>

<p>当你在 UI 中发现错误时，可以使用 <a href="https://github.com/facebook/react/tree/master/packages/react-devtools">React 开发者工具</a> 来检查问题组件的 props，并且按照组件树结构逐级向上搜寻，直到定位到负责更新 state 的那个组件。</p>

