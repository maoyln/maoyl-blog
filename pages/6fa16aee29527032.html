<h1 id="请求取消模块单元测试">请求取消模块单元测试</h1>

<p>请求取消模块是 <code class="language-plaintext highlighter-rouge">ts-axios</code> 库核心流程其中一个分支，也是非常重要的模块，我们将从基础库和业务流程模块 2 个方面去编写单元测试。</p>

<h2 id="cancel-类单元测试">Cancel 类单元测试</h2>

<p><code class="language-plaintext highlighter-rouge">cancel/Cancel.spec.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">Cancel</span><span class="p">,</span> <span class="p">{</span> <span class="nx">isCancel</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../src/cancel/Cancel</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">cancel:Cancel</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should returns correct result when message is specified</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">cancel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Cancel</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">cancel</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should returns true if value is a Cancel</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">isCancel</span><span class="p">(</span><span class="k">new</span> <span class="nx">Cancel</span><span class="p">())).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should returns false if value is not a Cancel</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">isCancel</span><span class="p">({</span> <span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span> <span class="p">})).</span><span class="nx">toBeFalsy</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="canceltoken-类单元测试">CancelToken 类单元测试</h2>

<p><code class="language-plaintext highlighter-rouge">cancel/CancelToken.spec.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">CancelToken</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../src/cancel/CancelToken</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">Cancel</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../src/cancel/Cancel</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Canceler</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../src/types</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">CancelToken</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">reason</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should returns a Cancel if cancellation has been requested</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="na">cancel</span><span class="p">:</span> <span class="nx">Canceler</span>
      <span class="kd">let</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CancelToken</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">cancel</span> <span class="o">=</span> <span class="nx">c</span>
      <span class="p">})</span>
      <span class="nx">cancel</span><span class="o">!</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">reason</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expect</span><span class="p">.</span><span class="kr">any</span><span class="p">(</span><span class="nx">Cancel</span><span class="p">))</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">reason</span><span class="o">!</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should has no side effect if call cancellation for multi times</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="na">cancel</span><span class="p">:</span> <span class="nx">Canceler</span>
      <span class="kd">let</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CancelToken</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">cancel</span> <span class="o">=</span> <span class="nx">c</span>
      <span class="p">})</span>
      <span class="nx">cancel</span><span class="o">!</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">cancel</span><span class="o">!</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">reason</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expect</span><span class="p">.</span><span class="kr">any</span><span class="p">(</span><span class="nx">Cancel</span><span class="p">))</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">reason</span><span class="o">!</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should returns undefined if cancellation has not been requested</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CancelToken</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// do nothing</span>
      <span class="p">})</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">reason</span><span class="p">).</span><span class="nx">toBeUndefined</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">promise</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should returns a Promise that resolves when cancellation is requested</span><span class="dl">'</span><span class="p">,</span> <span class="nx">done</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="na">cancel</span><span class="p">:</span> <span class="nx">Canceler</span>
      <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CancelToken</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">cancel</span> <span class="o">=</span> <span class="nx">c</span>
      <span class="p">})</span>
      <span class="nx">token</span><span class="p">.</span><span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">value</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expect</span><span class="p">.</span><span class="kr">any</span><span class="p">(</span><span class="nx">Cancel</span><span class="p">))</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
        <span class="nx">done</span><span class="p">()</span>
      <span class="p">})</span>
      <span class="nx">cancel</span><span class="o">!</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">throwIfRequested</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should throws if cancellation has been requested</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="na">cancel</span><span class="p">:</span> <span class="nx">Canceler</span>
      <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CancelToken</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">cancel</span> <span class="o">=</span> <span class="nx">c</span>
      <span class="p">})</span>
      <span class="nx">cancel</span><span class="o">!</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">token</span><span class="p">.</span><span class="nx">throwIfRequested</span><span class="p">()</span>
        <span class="nx">fail</span><span class="p">(</span><span class="dl">'</span><span class="s1">Expected throwIfRequested to throw.</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">thrown</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">thrown</span> <span class="k">instanceof</span> <span class="nx">Cancel</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">fail</span><span class="p">(</span><span class="dl">'</span><span class="s1">Expected throwIfRequested to throw a Cancel, but test threw </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">thrown</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">.</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">thrown</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should does not throw if cancellation has not been requested</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CancelToken</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// do nothing</span>
      <span class="p">})</span>
      <span class="nx">token</span><span class="p">.</span><span class="nx">throwIfRequested</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">source</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should returns an object containing token and cancel function</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">CancelToken</span><span class="p">.</span><span class="nx">source</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">token</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expect</span><span class="p">.</span><span class="kr">any</span><span class="p">(</span><span class="nx">CancelToken</span><span class="p">))</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">cancel</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expect</span><span class="p">.</span><span class="kr">any</span><span class="p">(</span><span class="nb">Function</span><span class="p">))</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">reason</span><span class="p">).</span><span class="nx">toBeUndefined</span><span class="p">()</span>
      <span class="nx">source</span><span class="p">.</span><span class="nx">cancel</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">reason</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expect</span><span class="p">.</span><span class="kr">any</span><span class="p">(</span><span class="nx">Cancel</span><span class="p">))</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">reason</span><span class="o">!</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>注意，这里我们使用了 <code class="language-plaintext highlighter-rouge">fail</code> 函数表示一个测试的失败，这个并未在 Jest 文档中体现，但它是一个可以用的 API。</p>

<h2 id="cancel-业务逻辑单元测试">Cancel 业务逻辑单元测试</h2>

<p><code class="language-plaintext highlighter-rouge">cancel.spec.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../src/index</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">getAjaxRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./helper</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">cancel</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">CancelToken</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">CancelToken</span>
  <span class="kd">const</span> <span class="nx">Cancel</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">Cancel</span>

  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">install</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">uninstall</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">when called before sending request</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should rejects Promise with a Cancel object</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">CancelToken</span><span class="p">.</span><span class="nx">source</span><span class="p">()</span>
      <span class="nx">source</span><span class="p">.</span><span class="nx">cancel</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>

      <span class="k">return</span> <span class="nx">axios</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">cancelToken</span><span class="p">:</span> <span class="nx">source</span><span class="p">.</span><span class="nx">token</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">reason</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">reason</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expect</span><span class="p">.</span><span class="kr">any</span><span class="p">(</span><span class="nx">Cancel</span><span class="p">))</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">reason</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">when called after request has been sent</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should rejects Promise with a Cancel object</span><span class="dl">'</span><span class="p">,</span> <span class="nx">done</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">CancelToken</span><span class="p">.</span><span class="nx">source</span><span class="p">()</span>
      <span class="nx">axios</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo/bar</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">cancelToken</span><span class="p">:</span> <span class="nx">source</span><span class="p">.</span><span class="nx">token</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">reason</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">reason</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expect</span><span class="p">.</span><span class="kr">any</span><span class="p">(</span><span class="nx">Cancel</span><span class="p">))</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">reason</span><span class="p">.</span><span class="nx">message</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
          <span class="nx">done</span><span class="p">()</span>
        <span class="p">})</span>

      <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">source</span><span class="p">.</span><span class="nx">cancel</span><span class="p">(</span><span class="dl">'</span><span class="s1">Operation has been canceled.</span><span class="dl">'</span><span class="p">)</span>
        <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">request</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">({</span>
            <span class="na">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="na">responseText</span><span class="p">:</span> <span class="dl">'</span><span class="s1">OK</span><span class="dl">'</span>
          <span class="p">})</span>
        <span class="p">},</span> <span class="mi">100</span><span class="p">)</span>
      <span class="p">})</span>
    <span class="p">})</span>

    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">calls abort on request object</span><span class="dl">'</span><span class="p">,</span> <span class="nx">done</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">CancelToken</span><span class="p">.</span><span class="nx">source</span><span class="p">()</span>
      <span class="kd">let</span> <span class="na">request</span><span class="p">:</span> <span class="kr">any</span>
      <span class="nx">axios</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo/bar</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">cancelToken</span><span class="p">:</span> <span class="nx">source</span><span class="p">.</span><span class="nx">token</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">statusText</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">abort</span><span class="dl">'</span><span class="p">)</span>
          <span class="nx">done</span><span class="p">()</span>
        <span class="p">})</span>

      <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">req</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">source</span><span class="p">.</span><span class="nx">cancel</span><span class="p">()</span>
        <span class="nx">request</span> <span class="o">=</span> <span class="nx">req</span>
      <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">when called after response has been received</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should not cause unhandled rejection</span><span class="dl">'</span><span class="p">,</span> <span class="nx">done</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">CancelToken</span><span class="p">.</span><span class="nx">source</span><span class="p">()</span>
      <span class="nx">axios</span>
        <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">cancelToken</span><span class="p">:</span> <span class="nx">source</span><span class="p">.</span><span class="nx">token</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">unhandledrejection</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">done</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="dl">'</span><span class="s1">Unhandled rejection.</span><span class="dl">'</span><span class="p">)</span>
          <span class="p">})</span>
          <span class="nx">source</span><span class="p">.</span><span class="nx">cancel</span><span class="p">()</span>
          <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">done</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">})</span>

      <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">({</span>
          <span class="na">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
          <span class="na">responseText</span><span class="p">:</span> <span class="dl">'</span><span class="s1">OK</span><span class="dl">'</span>
        <span class="p">})</span>
      <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>注意这里我们使用了 <code class="language-plaintext highlighter-rouge">done.fail</code> 表示了一个异常的结束，这个并未在 Jest 文档中体现，但它是一个可以用的 API。</p>

<p>至此，我们完成了取消模块相关业务逻辑的单元测试，我们测试覆盖率达到了阈值，测试已经通过了。但是扔未达到我们的目标，还有很多 feature 是没有覆盖到的。接下来我们就完成剩余 feature 的编写单元测试。</p>
