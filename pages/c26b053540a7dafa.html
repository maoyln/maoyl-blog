<h1 id="静态方法扩展">静态方法扩展</h1>

<h2 id="需求分析">需求分析</h2>

<p>官方 axios 库实现了 <code class="language-plaintext highlighter-rouge">axios.all</code>、<code class="language-plaintext highlighter-rouge">axios.spread</code> 等方法，它们的用法如下：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">getUserAccount</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/user/12345</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getUserPermissions</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/user/12345/permissions</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">axios</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">getUserAccount</span><span class="p">(),</span> <span class="nx">getUserPermissions</span><span class="p">()])</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">axios</span><span class="p">.</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">acct</span><span class="p">,</span> <span class="nx">perms</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Both requests are now complete</span>
  <span class="p">}));</span>
</code></pre></div></div>

<p>实际上，<code class="language-plaintext highlighter-rouge">axios.all</code> 就是 <code class="language-plaintext highlighter-rouge">Promise.all</code> 的封装，它返回的是一个 <code class="language-plaintext highlighter-rouge">Promise</code> 数组，<code class="language-plaintext highlighter-rouge">then</code> 函数的参数本应是一个参数为 <code class="language-plaintext highlighter-rouge">Promise resolves</code>（数组）的函数，在这里使用了 <code class="language-plaintext highlighter-rouge">axios.spread</code> 方法。所以 <code class="language-plaintext highlighter-rouge">axios.spread</code> 方法是接收一个函数，返回一个新的函数，新函数的结构满足 <code class="language-plaintext highlighter-rouge">then</code> 函数的参数结构。</p>

<p>个人认为 <code class="language-plaintext highlighter-rouge">axios</code> 这俩静态方法在目前看来很鸡肋，因为使用 <code class="language-plaintext highlighter-rouge">Promise</code> 一样可以完成这俩需求。</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">getUserAccount</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/user/12345</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getUserPermissions</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/user/12345/permissions</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">getUserAccount</span><span class="p">(),</span> <span class="nx">getUserPermissions</span><span class="p">()])</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(([</span><span class="nx">acct</span><span class="p">,</span><span class="nx">perms</span><span class="p">])</span> <span class="p">{</span>
    <span class="c1">// Both requests are now complete</span>
  <span class="p">}));</span>
</code></pre></div></div>
<p>在 <code class="language-plaintext highlighter-rouge">Promise.all</code> 的 <code class="language-plaintext highlighter-rouge">resolve</code> 函数中，我们可以直接通过数组的解构拿到每个请求对应的响应对象。</p>

<p>但是为了保持与官网 axios API 一致，我们也在 <code class="language-plaintext highlighter-rouge">ts-axios</code> 库中实现这俩方法。</p>

<p>官方 axios 库也通过 <code class="language-plaintext highlighter-rouge">axios.Axios</code> 对外暴露了 <code class="language-plaintext highlighter-rouge">Axios</code> 类(感觉也没有啥使用场景，但为了保持一致，我们也会实现)。</p>

<p>另外对于 axios 实例，官网还提供了 <code class="language-plaintext highlighter-rouge">getUri</code> 方法在不发送请求的前提下根据传入的配置返回一个 url，如下：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fakeConfig</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">baseURL</span><span class="p">:</span> <span class="dl">'</span><span class="s1">https://www.baidu.com/</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/user/12345</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">params</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">idClient</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="na">idTest</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="na">testString</span><span class="p">:</span> <span class="dl">'</span><span class="s1">thisIsATest</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">axios</span><span class="p">.</span><span class="nx">getUri</span><span class="p">(</span><span class="nx">fakeConfig</span><span class="p">))</span>
<span class="c1">// https://www.baidu.com/user/12345?idClient=1&amp;idTest=2&amp;testString=thisIsATest</span>
</code></pre></div></div>

<h2 id="代码实现">代码实现</h2>

<p>首先修改类型定义。</p>

<p><code class="language-plaintext highlighter-rouge">types/index.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kr">interface</span> <span class="nx">AxiosClassStatic</span> <span class="p">{</span>
  <span class="k">new</span> <span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">Axios</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">AxiosStatic</span> <span class="kd">extends</span> <span class="nx">AxiosInstance</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="nx">all</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">promises</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">|</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;&gt;</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="p">[]</span><span class="o">&gt;</span>

  <span class="nx">spread</span><span class="o">&lt;</span><span class="nx">T</span><span class="p">,</span> <span class="nx">R</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">callback</span><span class="p">:</span> <span class="p">(...</span><span class="nx">args</span><span class="p">:</span> <span class="nx">T</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="nx">R</span><span class="p">):</span> <span class="p">(</span><span class="nx">arr</span><span class="p">:</span> <span class="nx">T</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="nx">R</span>

  <span class="nx">Axios</span><span class="p">:</span> <span class="nx">AxiosClassStatic</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">Axios</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="nx">getUri</span><span class="p">(</span><span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="kr">string</span>
<span class="p">}</span>
</code></pre></div></div>

<p>然后我们去实现这几个静态方法。</p>

<p><code class="language-plaintext highlighter-rouge">axios.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span><span class="p">.</span><span class="nx">all</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">axios</span><span class="p">.</span><span class="nx">spread</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">spread</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="nx">wrap</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">arr</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">axios</span><span class="p">.</span><span class="nx">Axios</span> <span class="o">=</span> <span class="nx">Axios</span>
</code></pre></div></div>

<p>最后我们去给 Axios 添加实例方法 <code class="language-plaintext highlighter-rouge">getUri</code>。</p>

<p><code class="language-plaintext highlighter-rouge">core/Axios.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">getUri</span><span class="p">(</span><span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
  <span class="nx">config</span> <span class="o">=</span> <span class="nx">mergeConfig</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">defaults</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">transformURL</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>先和默认配置合并，然后再通过 <code class="language-plaintext highlighter-rouge">dispatchRequest</code> 中实现的 <code class="language-plaintext highlighter-rouge">transformURL</code> 返回一个新的 <code class="language-plaintext highlighter-rouge">url</code>。</p>

<h2 id="demo-编写">demo 编写</h2>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">getA</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/more/A</span><span class="dl">'</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getB</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/more/B</span><span class="dl">'</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">axios</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">getA</span><span class="p">(),</span> <span class="nx">getB</span><span class="p">()])</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">axios</span><span class="p">.</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resA</span><span class="p">,</span> <span class="nx">resB</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">resA</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">resB</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">}))</span>


<span class="nx">axios</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">getA</span><span class="p">(),</span> <span class="nx">getB</span><span class="p">()])</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(([</span><span class="nx">resA</span><span class="p">,</span> <span class="nx">resB</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">resA</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">resB</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">})</span>

<span class="kd">const</span> <span class="nx">fakeConfig</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">baseURL</span><span class="p">:</span> <span class="dl">'</span><span class="s1">https://www.baidu.com/</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/user/12345</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">params</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">idClient</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="na">idTest</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="na">testString</span><span class="p">:</span> <span class="dl">'</span><span class="s1">thisIsATest</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">axios</span><span class="p">.</span><span class="nx">getUri</span><span class="p">(</span><span class="nx">fakeConfig</span><span class="p">))</span>
</code></pre></div></div>

<p>这里我们通过 <code class="language-plaintext highlighter-rouge">axios.all</code> 同时发出了 2 个请求，返回了 <code class="language-plaintext highlighter-rouge">Promise</code> 数组，，我们可以在 <code class="language-plaintext highlighter-rouge">axios.spread</code> 的参数函数中拿到结果，也可以直接在 then 函数的参数函数中拿到结果。另外，我们可以根据 <code class="language-plaintext highlighter-rouge">axios.getUri</code> 方法在不发送请求的情况下根据配置得到最终请求的 url 结果。</p>

<p>至此，<code class="language-plaintext highlighter-rouge">ts-axios</code> 就实现了官网 axios 库在浏览器端的所有需求。如果你学到了这里，先为自己鼓个掌吧，因为我们已经获得了阶段性的学习成果了。</p>

<p>目前为止，我们对于所写代码的验证都是通过 demo 的方式，但是 demo 毕竟难以覆盖所有场景和代码分支，为了保证代码的正确性，我们还需要更科学的方式。从下一章开始，我们会学习编写单元测试，通过单元测试的方式来保证我们的代码正确性。</p>
