<h1 id="http-授权">HTTP 授权</h1>

<h2 id="需求分析">需求分析</h2>

<p>HTTP 协议中的 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Authorization">Authorization</a> 请求 header 会包含服务器用于验证用户代理身份的凭证，通常会在服务器返回 401 Unauthorized 状态码以及 WWW-Authenticate 消息头之后在后续请求中发送此消息头。</p>

<p>axios 库也允许你在请求配置中配置 <code class="language-plaintext highlighter-rouge">auth</code> 属性，<code class="language-plaintext highlighter-rouge">auth</code> 是一个对象结构，包含 <code class="language-plaintext highlighter-rouge">username</code> 和 <code class="language-plaintext highlighter-rouge">password</code> 2 个属性。一旦用户在请求的时候配置这俩属性，我们就会自动往 HTTP 的 请求 header 中添加 <code class="language-plaintext highlighter-rouge">Authorization</code> 属性，它的值为 <code class="language-plaintext highlighter-rouge">Basic 加密串</code>。
这里的加密串是 <code class="language-plaintext highlighter-rouge">username:password</code> base64 加密后的结果。</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/more/post</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">a</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="na">auth</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">username</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Yee</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">password</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123456</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="代码实现">代码实现</h2>

<p>首先修改一下类型定义。</p>

<p><code class="language-plaintext highlighter-rouge">types/index.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kr">interface</span> <span class="nx">AxiosRequestConfig</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nl">auth</span><span class="p">?:</span> <span class="nx">AxiosBasicCredentials</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">AxiosBasicCredentials</span> <span class="p">{</span>
  <span class="nl">username</span><span class="p">:</span> <span class="kr">string</span>
  <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span>
<span class="p">}</span>
</code></pre></div></div>

<p>接着修改合并规则，因为 auth 也是一个对象格式，所以它的合并规则是 <code class="language-plaintext highlighter-rouge">deepMergeStrat</code>。</p>

<p><code class="language-plaintext highlighter-rouge">core/mergeConfig.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">stratKeysDeepMerge</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">headers</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">auth</span><span class="dl">'</span><span class="p">]</span>
</code></pre></div></div>

<p>然后修改发送请求前的逻辑。</p>

<p><code class="language-plaintext highlighter-rouge">core/xhr.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span>
  <span class="cm">/*...*/</span>
  <span class="nx">auth</span>
<span class="p">}</span> <span class="o">=</span> <span class="nx">config</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">auth</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Basic </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">btoa</span><span class="p">(</span><span class="nx">auth</span><span class="p">.</span><span class="nx">username</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">:</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="demo-编写">demo 编写</h2>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/more/post</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">a</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="na">auth</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">username</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Yee</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">password</span><span class="p">:</span> <span class="dl">'</span><span class="s1">123456</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>另外，我们在 <code class="language-plaintext highlighter-rouge">server.js</code> 中对于这个路由接口写了一段小逻辑：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/more/post</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">type</span><span class="p">,</span> <span class="nx">credentials</span><span class="p">]</span> <span class="o">=</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1"> </span><span class="dl">'</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">atob</span><span class="p">(</span><span class="nx">credentials</span><span class="p">))</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">]</span> <span class="o">=</span> <span class="nx">atob</span><span class="p">(</span><span class="nx">credentials</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Basic</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="nx">username</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">Yee</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="nx">password</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">123456</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">'</span><span class="s1">UnAuthorization</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<p>注意，这里我们需要安装第三方库 <code class="language-plaintext highlighter-rouge">atob</code> 实现 base64 串的解码。</p>

<p>至此，<code class="language-plaintext highlighter-rouge">ts-axios</code> 支持了 HTTP 授权功能，用户可以通过配置 auth 对象实现自动在请求 header 中添加 <code class="language-plaintext highlighter-rouge">Authorization</code> 属性。下一节课我们来实现自定义合法状态码功能。</p>
