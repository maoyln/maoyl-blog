<h1 id="jest-安装和配置">Jest 安装和配置</h1>

<h2 id="jest-安装">Jest 安装</h2>

<p>由于我们的项目是使用 <code class="language-plaintext highlighter-rouge">typescript-library-starter</code> 初始化的，已经内置了 Jest 的安装，但是安装的版本却不是最新的，我们可以对 <code class="language-plaintext highlighter-rouge">package.json</code> 中的相关依赖版本做修改，重新安装。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"@types/jest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^24.0.13"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"jest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^24.8.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"jest-config"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^24.8.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"ts-jest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^24.0.2"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"typescript"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^3.4.5"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<blockquote>
  <p>注意，这里都是目前最新的版本，未来如果有版本升级的话，可以自行更新到最新版本。</p>
</blockquote>

<p>更改版本后，在命令行再次执行 <code class="language-plaintext highlighter-rouge">npm install</code> 即可安装到相应版本。</p>

<h2 id="jest-配置">Jest 配置</h2>

<p>在 <code class="language-plaintext highlighter-rouge">package.json</code> 文件中有 <code class="language-plaintext highlighter-rouge">jest</code> 字段，对应 Jest 配置：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"jest"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"transform"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">".(ts|tsx)"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ts-jest"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"testEnvironment"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jsdom"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"testRegex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/test/.*</span><span class="se">\\</span><span class="s2">.(test|spec)</span><span class="se">\\</span><span class="s2">.(ts)$"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"moduleFileExtensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"ts"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"tsx"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"js"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"coverageThreshold"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"global"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"branches"</span><span class="p">:</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w">
      </span><span class="nl">"functions"</span><span class="p">:</span><span class="w"> </span><span class="mi">95</span><span class="p">,</span><span class="w">
      </span><span class="nl">"lines"</span><span class="p">:</span><span class="w"> </span><span class="mi">95</span><span class="p">,</span><span class="w">
      </span><span class="nl">"statements"</span><span class="p">:</span><span class="w"> </span><span class="mi">95</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"collectCoverageFrom"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"src/*.{js,ts}"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"src/**/*.{js,ts}"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"setupFilesAfterEnv"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"&lt;rootDir&gt;/test/boot.ts"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>

<p>接下来，我们就分别来看这几个配置的含义。</p>

<ul>
  <li><a href="https://jestjs.io/docs/en/configuration#transform-object-string-string">transform</a></li>
</ul>

<p>简单地说就是一种转换器配置，比如我们这里的</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"transform"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">".(ts|tsx)"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ts-jest"</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>

<p>表示的就是使用 <code class="language-plaintext highlighter-rouge">ts-jest</code> 工具把 <code class="language-plaintext highlighter-rouge">.ts</code> 和 <code class="language-plaintext highlighter-rouge">.tsx</code> 文件内容转换成 JavaScript，因为我们也是使用 TypeScript 编写测试代码，而 Node.js 是不能直接支持 TypeScript 的，所以需要配置转换器。</p>

<ul>
  <li><a href="https://jestjs.io/docs/en/configuration#testenvironment-string">testEnvironment</a></li>
</ul>

<p>测试环境。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"testEnvironment"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jsdom"</span><span class="w">
</span></code></pre></div></div>

<p>表示它是一个类浏览器的测试环境，我们可以使用浏览器环境中的一些 API。</p>

<ul>
  <li><a href="https://jestjs.io/docs/en/configuration#testregex-string-array-string">testRegex</a></li>
</ul>

<p>要测试文件的正则表达式。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"testRegex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/test/.*</span><span class="se">\\</span><span class="s2">.(test|spec)</span><span class="se">\\</span><span class="s2">.(ts)$"</span><span class="w">
</span></code></pre></div></div>

<p>表示 <code class="language-plaintext highlighter-rouge">test</code> 目录下所有以 <code class="language-plaintext highlighter-rouge">.test.ts</code> 和 <code class="language-plaintext highlighter-rouge">.spec.ts</code> 的文件都需要跑测试。</p>

<ul>
  <li><a href="https://jestjs.io/docs/en/configuration#modulefileextensions-array-string">moduleFileExtensions</a></li>
</ul>

<p>模块文件扩展名，当你去引入一个模块并没有指定扩展名的时候，它会依次尝试去添加这些扩展名去找你引入的模块文件。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"moduleFileExtensions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
  </span><span class="s2">"ts"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"tsx"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"js"</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>表示优先找 <code class="language-plaintext highlighter-rouge">.ts</code> 的模块、然后是 <code class="language-plaintext highlighter-rouge">.tsx</code>，最后是 <code class="language-plaintext highlighter-rouge">.js</code>。</p>

<ul>
  <li><a href="https://jestjs.io/docs/en/configuration#coveragethreshold-object">coverageThreshold</a></li>
</ul>

<p>测试覆盖率的阈值设定，当我们的测试覆盖率达不到阈值的时候，测试会失败。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"coverageThreshold"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"global"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"branches"</span><span class="p">:</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w">
    </span><span class="nl">"functions"</span><span class="p">:</span><span class="w"> </span><span class="mi">95</span><span class="p">,</span><span class="w">
    </span><span class="nl">"lines"</span><span class="p">:</span><span class="w"> </span><span class="mi">95</span><span class="p">,</span><span class="w">
    </span><span class="nl">"statements"</span><span class="p">:</span><span class="w"> </span><span class="mi">95</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>表示全局的代码分支覆盖率要达到 <code class="language-plaintext highlighter-rouge">90%</code>，方法覆盖率要达到 <code class="language-plaintext highlighter-rouge">95%</code>，代码行数覆盖率达到 <code class="language-plaintext highlighter-rouge">95%</code>，声明覆盖率达到 <code class="language-plaintext highlighter-rouge">95%</code>。</p>

<ul>
  <li><a href="https://jestjs.io/docs/en/configuration#collectcoveragefrom-array">collectCoverageFrom</a></li>
</ul>

<p>收集指定文件的测试覆盖率(即使你没为这些文件编写测试)，它的值为 <a href="https://github.com/jonschlinkert/micromatch">glob patterns</a> 类型。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"collectCoverageFrom"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
  </span><span class="s2">"src/*.{js,ts}"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"src/**/*.{js,ts}"</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>表示收集 <code class="language-plaintext highlighter-rouge">src</code> 目录以及它的所有子目录中的 <code class="language-plaintext highlighter-rouge">js</code> 和 <code class="language-plaintext highlighter-rouge">ts</code> 文件的测试覆盖率。</p>

<ul>
  <li><a href="https://jestjs.io/docs/en/configuration#setupfilesafterenv-array">setupFilesAfterEnv</a></li>
</ul>

<p>测试框架安装后立即执行的代码文件列表。</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"setupFilesAfterEnv"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
  </span><span class="s2">"&lt;rootDir&gt;/test/boot.ts"</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>表示每次跑具体测试代码之前会先运行 <code class="language-plaintext highlighter-rouge">&lt;rootDir&gt;/test/boot.ts</code> 中的代码，<code class="language-plaintext highlighter-rouge">&lt;rootDir&gt;</code> 表示当前项目的根目录。这个配置在之后的章节我们会具体介绍。</p>

<p>其他关于 Jest 的配置，感兴趣的同学可以去<a href="https://jestjs.io/docs/en/configuration">官网</a>做扩展学习。</p>

<p>至此，我们学习了 Jest 的安装和配置，下节课我们就开始编写 <code class="language-plaintext highlighter-rouge">ts-axios</code> 库的单元测试。</p>
