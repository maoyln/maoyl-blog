<h1 id="请求和响应配置化">请求和响应配置化</h1>

<h2 id="需求分析">需求分析</h2>

<p>官方的 axios 库 给默认配置添加了 <code class="language-plaintext highlighter-rouge">transformRequest</code> 和 <code class="language-plaintext highlighter-rouge">transformResponse</code> 两个字段，它们的值是一个数组或者是一个函数。</p>

<p>其中 <code class="language-plaintext highlighter-rouge">transformRequest</code> 允许你在将请求数据发送到服务器之前对其进行修改，这只适用于请求方法 <code class="language-plaintext highlighter-rouge">put</code>、<code class="language-plaintext highlighter-rouge">post</code> 和 <code class="language-plaintext highlighter-rouge">patch</code>，如果值是数组，则数组中的最后一个函数必须返回一个字符串或 <code class="language-plaintext highlighter-rouge">FormData</code>、<code class="language-plaintext highlighter-rouge">URLSearchParams</code>、<code class="language-plaintext highlighter-rouge">Blob</code> 等类型作为 <code class="language-plaintext highlighter-rouge">xhr.send</code> 方法的参数，而且在 <code class="language-plaintext highlighter-rouge">transform</code> 过程中可以修改  <code class="language-plaintext highlighter-rouge">headers</code> 对象。</p>

<p>而 <code class="language-plaintext highlighter-rouge">transformResponse</code> 允许你在把响应数据传递给 <code class="language-plaintext highlighter-rouge">then</code> 或者 <code class="language-plaintext highlighter-rouge">catch</code> 之前对它们进行修改。</p>

<p>当值为数组的时候，数组的每一个函数都是一个转换函数，数组中的函数就像管道一样依次执行，前者的输出作为后者的输入。</p>

<p>举个例子：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span><span class="p">({</span>
  <span class="na">transformRequest</span><span class="p">:</span> <span class="p">[(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">}),</span> <span class="p">...</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">transformRequest</span><span class="p">],</span>
  <span class="na">transformResponse</span><span class="p">:</span> <span class="p">[</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">transformResponse</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">data</span>
  <span class="p">}],</span>
  <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/config/post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">a</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="修改默认配置">修改默认配置</h2>

<p>先修改 <code class="language-plaintext highlighter-rouge">AxiosRequestConfig</code> 的类型定义，添加 <code class="language-plaintext highlighter-rouge">transformRequest</code> 和 <code class="language-plaintext highlighter-rouge">transformResponse</code> 俩个可选属性。</p>

<p><code class="language-plaintext highlighter-rouge">types/index.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kr">interface</span> <span class="nx">AxiosRequestConfig</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nl">transformRequest</span><span class="p">?:</span> <span class="nx">AxiosTransformer</span> <span class="o">|</span> <span class="nx">AxiosTransformer</span><span class="p">[]</span>
  <span class="nx">transformResponse</span><span class="p">?:</span> <span class="nx">AxiosTransformer</span> <span class="o">|</span> <span class="nx">AxiosTransformer</span><span class="p">[]</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">AxiosTransformer</span> <span class="p">{</span>
  <span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">headers</span><span class="p">?:</span> <span class="kr">any</span><span class="p">):</span> <span class="kr">any</span>
<span class="p">}</span>
</code></pre></div></div>

<p>接着修改默认配置，如下：</p>

<p><code class="language-plaintext highlighter-rouge">defaults.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">processHeaders</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./helpers/headers</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">transformRequest</span><span class="p">,</span> <span class="nx">transformResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./helpers/data</span><span class="dl">'</span>

<span class="kd">const</span> <span class="nx">defaults</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="na">transformRequest</span><span class="p">:</span> <span class="p">[</span>
    <span class="kd">function</span><span class="p">(</span><span class="na">data</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="kr">any</span><span class="p">):</span> <span class="kr">any</span> <span class="p">{</span>
      <span class="nx">processHeaders</span><span class="p">(</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">transformRequest</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">],</span>

  <span class="na">transformResponse</span><span class="p">:</span> <span class="p">[</span>
    <span class="kd">function</span><span class="p">(</span><span class="na">data</span><span class="p">:</span> <span class="kr">any</span><span class="p">):</span> <span class="kr">any</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">transformResponse</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我们把之前对请求数据和响应数据的处理逻辑，放到了默认配置中，也就是默认处理逻辑。</p>

<h2 id="transform-逻辑重构">transform 逻辑重构</h2>

<p>接下来，我们就要重构之前写的对请求数据和响应数据的处理逻辑了。由于我们可能会编写多个转换函数，我们先定义一个 <code class="language-plaintext highlighter-rouge">transform</code> 函数来处理这些转换函数的调用逻辑。</p>

<p><code class="language-plaintext highlighter-rouge">core/transform.ts</code></p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">AxiosTransformer</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../types</span><span class="dl">'</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">transform</span><span class="p">(</span>
  <span class="nx">data</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span>
  <span class="nx">headers</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span>
  <span class="nx">fns</span><span class="p">?:</span> <span class="nx">AxiosTransformer</span> <span class="o">|</span> <span class="nx">AxiosTransformer</span><span class="p">[]</span>
<span class="p">):</span> <span class="kr">any</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fns</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">data</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">fns</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">fns</span> <span class="o">=</span> <span class="p">[</span><span class="nx">fns</span><span class="p">]</span>
  <span class="p">}</span>
  <span class="nx">fns</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">fn</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">data</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">headers</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="k">return</span> <span class="nx">data</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">transform</code> 函数中接收 <code class="language-plaintext highlighter-rouge">data</code>、<code class="language-plaintext highlighter-rouge">headers</code>、<code class="language-plaintext highlighter-rouge">fns</code> 3 个参数，其中 <code class="language-plaintext highlighter-rouge">fns</code> 代表一个或者多个转换函数，内部逻辑很简单，遍历 <code class="language-plaintext highlighter-rouge">fns</code>，执行这些转换函数，并且把 <code class="language-plaintext highlighter-rouge">data</code> 和 <code class="language-plaintext highlighter-rouge">headers</code> 作为参数传入，每个转换函数返回的 <code class="language-plaintext highlighter-rouge">data</code> 会作为下一个转换函数的参数 <code class="language-plaintext highlighter-rouge">data</code> 传入。</p>

<p>接下来修改对请求数据和响应数据的处理逻辑。</p>

<p><code class="language-plaintext highlighter-rouge">dispatchRequest.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">import</span> <span class="nx">transform</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./transform</span><span class="dl">'</span>

<span class="kd">function</span> <span class="nx">processConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">transformURL</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">transformRequest</span><span class="p">)</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="nx">flattenHeaders</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">method</span><span class="o">!</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">transformResponseData</span><span class="p">(</span><span class="nx">res</span><span class="p">:</span> <span class="nx">AxiosResponse</span><span class="p">):</span> <span class="nx">AxiosResponse</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">transformResponse</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">res</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我们把对请求数据的处理和对响应数据的处理改成使用 <code class="language-plaintext highlighter-rouge">transform</code> 函数实现，并把配置中的 <code class="language-plaintext highlighter-rouge">transformRequest</code> 及 <code class="language-plaintext highlighter-rouge">transformResponse</code> 分别传入。</p>

<h2 id="demo-编写">demo 编写</h2>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span><span class="p">({</span>
  <span class="na">transformRequest</span><span class="p">:</span> <span class="p">[(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">}),</span> <span class="p">...(</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">transformRequest</span> <span class="k">as</span> <span class="nx">AxiosTransformer</span><span class="p">[])],</span>
  <span class="na">transformResponse</span><span class="p">:</span> <span class="p">[...(</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">transformResponse</span> <span class="k">as</span> <span class="nx">AxiosTransformer</span><span class="p">[]),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">data</span>
  <span class="p">}],</span>
  <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/config/post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">a</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>我们对 <code class="language-plaintext highlighter-rouge">transformRequest</code> 做了修改，在执行它默认的 <code class="language-plaintext highlighter-rouge">transformRequest</code> 之前，我们先用 <code class="language-plaintext highlighter-rouge">qs.stringify</code> 库对传入的数据 <code class="language-plaintext highlighter-rouge">data</code> 做了一层转换。同时也对 <code class="language-plaintext highlighter-rouge">transformResponse</code> 做了修改，在执行完默认的 <code class="language-plaintext highlighter-rouge">transformResponse</code> 后，会给响应的 <code class="language-plaintext highlighter-rouge">data</code> 对象添加一个 <code class="language-plaintext highlighter-rouge">data.b = 2</code>。</p>

<p>因为之前我们实现了配置的合并，而且我们传入的 <code class="language-plaintext highlighter-rouge">transformRequest</code> 和 <code class="language-plaintext highlighter-rouge">transformResponse</code> 遵循默认合并策略，它们会覆盖默认的值。</p>

<p>至此，我们就实现了请求和响应的配置化。到目前为止，我们的 axios 都是一个单例，一旦我们修改了 axios 的默认配置，会影响所有的请求。官网提供了一个 <code class="language-plaintext highlighter-rouge">axios.create</code> 的工厂方法允许我们创建一个新的 <code class="language-plaintext highlighter-rouge">axios</code> 实例，同时允许我们传入新的配置和默认配置合并，并做为新的默认配置。下面一节课我们就来实现这个 feature。</p>
