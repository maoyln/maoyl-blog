<h1 id="剩余模块单元测试">剩余模块单元测试</h1>

<h2 id="defaults-模块单元测试">defaults 模块单元测试</h2>

<p><code class="language-plaintext highlighter-rouge">defaults</code> 模块为请求配置提供了一些默认的属性和方法，我们需要为其编写单元测试。</p>

<p><code class="language-plaintext highlighter-rouge">test/defaults.spec.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span><span class="p">,</span> <span class="p">{</span> <span class="nx">AxiosTransformer</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../src/index</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">getAjaxRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./helper</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">deepMerge</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../src/helpers/util</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">defaults</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">install</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">uninstall</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should transform request json</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">((</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">transformRequest</span> <span class="k">as</span> <span class="nx">AxiosTransformer</span><span class="p">[])[</span><span class="mi">0</span><span class="p">]({</span> <span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span> <span class="p">})).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"foo":"bar"}</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should do nothing to request string</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">((</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">transformRequest</span> <span class="k">as</span> <span class="nx">AxiosTransformer</span><span class="p">[])[</span><span class="mi">0</span><span class="p">](</span><span class="dl">'</span><span class="s1">foo=bar</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">foo=bar</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should transform response json</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">(</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">transformResponse</span> <span class="k">as</span> <span class="nx">AxiosTransformer</span><span class="p">[])[</span><span class="mi">0</span><span class="p">](</span><span class="dl">'</span><span class="s1">{"foo":"bar"}</span><span class="dl">'</span><span class="p">)</span>

    <span class="nx">expect</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">foo</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should do nothing to response string</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">((</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">transformResponse</span> <span class="k">as</span> <span class="nx">AxiosTransformer</span><span class="p">[])[</span><span class="mi">0</span><span class="p">](</span><span class="dl">'</span><span class="s1">foo=bar</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">foo=bar</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should use global defaults config</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">axios</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should use modified defaults config</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">baseURL</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">http://example.com/</span><span class="dl">'</span>

    <span class="nx">axios</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://example.com/foo</span><span class="dl">'</span><span class="p">)</span>
      <span class="k">delete</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">baseURL</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should use request config</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">axios</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">baseURL</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://www.example.com</span><span class="dl">'</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://www.example.com/foo</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should use default config for custom instance</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
      <span class="na">xsrfCookieName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">CUSTOM-XSRF-TOKEN</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">xsrfHeaderName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">X-CUSTOM-XSRF-TOKEN</span><span class="dl">'</span>
    <span class="p">})</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">xsrfCookieName</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">=foobarbaz</span><span class="dl">'</span>

    <span class="nx">instance</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">requestHeaders</span><span class="p">[</span><span class="nx">instance</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">xsrfHeaderName</span><span class="o">!</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">foobarbaz</span><span class="dl">'</span><span class="p">)</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span>
        <span class="nx">instance</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">xsrfCookieName</span> <span class="o">+</span>
        <span class="dl">'</span><span class="s1">=;expires=</span><span class="dl">'</span> <span class="o">+</span>
        <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="mi">86400000</span><span class="p">).</span><span class="nx">toUTCString</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should use GET headers</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="kd">get</span><span class="p">[</span><span class="dl">'</span><span class="s1">X-CUSTOM-HEADER</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">foo</span><span class="dl">'</span>
    <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">requestHeaders</span><span class="p">[</span><span class="dl">'</span><span class="s1">X-CUSTOM-HEADER</span><span class="dl">'</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">foo</span><span class="dl">'</span><span class="p">)</span>
      <span class="k">delete</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="kd">get</span><span class="p">[</span><span class="dl">'</span><span class="s1">X-CUSTOM-HEADER</span><span class="dl">'</span><span class="p">]</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should use POST headers</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">post</span><span class="p">[</span><span class="dl">'</span><span class="s1">X-CUSTOM-HEADER</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">foo</span><span class="dl">'</span>
    <span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">requestHeaders</span><span class="p">[</span><span class="dl">'</span><span class="s1">X-CUSTOM-HEADER</span><span class="dl">'</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">foo</span><span class="dl">'</span><span class="p">)</span>
      <span class="k">delete</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">post</span><span class="p">[</span><span class="dl">'</span><span class="s1">X-CUSTOM-HEADER</span><span class="dl">'</span><span class="p">]</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should use header config</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
      <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">common</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">'</span><span class="s1">X-COMMON-HEADER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">commonHeaderValue</span><span class="dl">'</span>
        <span class="p">},</span>
        <span class="na">get</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">'</span><span class="s1">X-GET-HEADER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">getHeaderValue</span><span class="dl">'</span>
        <span class="p">},</span>
        <span class="na">post</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">'</span><span class="s1">X-POST-HEADER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">postHeaderValue</span><span class="dl">'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="nx">instance</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">'</span><span class="s1">X-FOO-HEADER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">fooHeaderValue</span><span class="dl">'</span><span class="p">,</span>
        <span class="dl">'</span><span class="s1">X-BAR-HEADER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">barHeaderValue</span><span class="dl">'</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">requestHeaders</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span>
        <span class="nx">deepMerge</span><span class="p">(</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">common</span><span class="p">,</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="kd">get</span><span class="p">,</span> <span class="p">{</span>
          <span class="dl">'</span><span class="s1">X-COMMON-HEADER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">commonHeaderValue</span><span class="dl">'</span><span class="p">,</span>
          <span class="dl">'</span><span class="s1">X-GET-HEADER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">getHeaderValue</span><span class="dl">'</span><span class="p">,</span>
          <span class="dl">'</span><span class="s1">X-FOO-HEADER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">fooHeaderValue</span><span class="dl">'</span><span class="p">,</span>
          <span class="dl">'</span><span class="s1">X-BAR-HEADER</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">barHeaderValue</span><span class="dl">'</span>
        <span class="p">})</span>
      <span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should be used by custom instance if set before instance created</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">baseURL</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">http://example.org/</span><span class="dl">'</span>
    <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>

    <span class="nx">instance</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://example.org/foo</span><span class="dl">'</span><span class="p">)</span>
      <span class="k">delete</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">baseURL</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should not be used by custom instance if set after instance created</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>
    <span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">baseURL</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">http://example.org/</span><span class="dl">'</span>

    <span class="nx">instance</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="transform-模块单元测试">transform 模块单元测试</h2>

<p><code class="language-plaintext highlighter-rouge">transform</code> 模块用来定义请求和响应的转换方法，我们需要为其编写单元测试。</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span><span class="p">,</span> <span class="p">{</span> <span class="nx">AxiosResponse</span><span class="p">,</span> <span class="nx">AxiosTransformer</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../src/index</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">getAjaxRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./helper</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">transform</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">install</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">uninstall</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should transform JSON to string</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span>
    <span class="p">}</span>

    <span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"foo":"bar"}</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should transform string to JSON</span><span class="dl">'</span><span class="p">,</span> <span class="nx">done</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="na">response</span><span class="p">:</span> <span class="nx">AxiosResponse</span>

    <span class="nx">axios</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">response</span> <span class="o">=</span> <span class="nx">res</span>
    <span class="p">})</span>

    <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">({</span>
        <span class="na">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="na">responseText</span><span class="p">:</span> <span class="dl">'</span><span class="s1">{"foo": "bar"}</span><span class="dl">'</span>
      <span class="p">})</span>

      <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">)</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">foo</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span><span class="p">)</span>
        <span class="nx">done</span><span class="p">()</span>
      <span class="p">},</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should override default transform</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span>
    <span class="p">}</span>

    <span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">transformRequest</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">data</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span> <span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span> <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should allow an Array of transformers</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span>
    <span class="p">}</span>

    <span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">transformRequest</span><span class="p">:</span> <span class="p">(</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">transformRequest</span> <span class="k">as</span> <span class="nx">AxiosTransformer</span><span class="p">[]).</span><span class="nx">concat</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span>
        <span class="nx">data</span>
      <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">baz</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">})</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">params</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"foo":"baz"}</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should allowing mutating headers</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">64</span><span class="p">)).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span>

    <span class="nx">axios</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">transformRequest</span><span class="p">:</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">headers</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">X-Authorization</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">token</span>
        <span class="k">return</span> <span class="nx">data</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">requestHeaders</span><span class="p">[</span><span class="dl">'</span><span class="s1">X-Authorization</span><span class="dl">'</span><span class="p">]).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="xsrf-模块单元测试">xsrf 模块单元测试</h2>

<p><code class="language-plaintext highlighter-rouge">xsrf</code> 模块提供了一套防御 <code class="language-plaintext highlighter-rouge">xsrf</code> 攻击的解决方案，我们需要为其编写单元测试。</p>

<p><code class="language-plaintext highlighter-rouge">test/xsrf.spec.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../src/index</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">getAjaxRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./helper</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">xsrf</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">install</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">uninstall</span><span class="p">()</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span>
      <span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">xsrfCookieName</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">=;expires=</span><span class="dl">'</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="mi">86400000</span><span class="p">).</span><span class="nx">toUTCString</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should not set xsrf header if cookie is null</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">axios</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">requestHeaders</span><span class="p">[</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">xsrfHeaderName</span><span class="o">!</span><span class="p">]).</span><span class="nx">toBeUndefined</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should set xsrf header if cookie is set</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">xsrfCookieName</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">=12345</span><span class="dl">'</span>

    <span class="nx">axios</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">requestHeaders</span><span class="p">[</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">xsrfHeaderName</span><span class="o">!</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">12345</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should not set xsrf header for cross origin</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">xsrfCookieName</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">=12345</span><span class="dl">'</span>

    <span class="nx">axios</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://example.com/</span><span class="dl">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">requestHeaders</span><span class="p">[</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">xsrfHeaderName</span><span class="o">!</span><span class="p">]).</span><span class="nx">toBeUndefined</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should set xsrf header for cross origin when using withCredentials</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">xsrfCookieName</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">=12345</span><span class="dl">'</span>

    <span class="nx">axios</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://example.com/</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">withCredentials</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">requestHeaders</span><span class="p">[</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">xsrfHeaderName</span><span class="o">!</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">12345</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>注意在 <code class="language-plaintext highlighter-rouge">afterEach</code> 函数中我们清空了 <code class="language-plaintext highlighter-rouge">xsrf</code> 相关的 cookie。</p>

<h2 id="上传下载模块单元测试">上传下载模块单元测试</h2>

<p>上传下载模块允许我们监听上传和下载的进度，我们需要为其编写单元测试。</p>

<p><code class="language-plaintext highlighter-rouge">test/progress.spec.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../src/index</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">getAjaxRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./helper</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">progress</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">install</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">uninstall</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should add a download progress handler</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">progressSpy</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()</span>

    <span class="nx">axios</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">onDownloadProgress</span><span class="p">:</span> <span class="nx">progressSpy</span> <span class="p">})</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">request</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">({</span>
        <span class="na">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="na">responseText</span><span class="p">:</span> <span class="dl">'</span><span class="s1">{"foo": "bar"}</span><span class="dl">'</span>
      <span class="p">})</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">progressSpy</span><span class="p">).</span><span class="nx">toHaveBeenCalled</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should add a upload progress handler</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">progressSpy</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()</span>

    <span class="nx">axios</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">onUploadProgress</span><span class="p">:</span> <span class="nx">progressSpy</span> <span class="p">})</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// Jasmine AJAX doesn't trigger upload events.Waiting for jest-ajax fix</span>
      <span class="c1">// expect(progressSpy).toHaveBeenCalled()</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>注意，由于 <code class="language-plaintext highlighter-rouge">jasmine-ajax</code> 插件不会派发 <code class="language-plaintext highlighter-rouge">upload</code> 事件，这个未来可以通过我们自己编写的 <code class="language-plaintext highlighter-rouge">jest-ajax</code> 插件来解决，目前不写断言的情况它会直接通过。</p>

<h2 id="http-授权模块单元测试">HTTP 授权模块单元测试</h2>

<p>HTTP 授权模块为我们在请求头中添加 <code class="language-plaintext highlighter-rouge">Authorization</code> 字段，我们需要为其编写单元测试。</p>

<p><code class="language-plaintext highlighter-rouge">test/auth.spec.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../src/index</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">getAjaxRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./helper</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">auth</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">install</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">uninstall</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should accept HTTP Basic auth with username/password</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">axios</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">auth</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">username</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Aladdin</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="dl">'</span><span class="s1">open sesame</span><span class="dl">'</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">requestHeaders</span><span class="p">[</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">]).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should fail to encode HTTP Basic auth credentials with non-Latin1 characters</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">axios</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">auth</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">username</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Aladßç£☃din</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="dl">'</span><span class="s1">open sesame</span><span class="dl">'</span>
      <span class="p">}</span>
    <span class="p">})</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span>
          <span class="dl">'</span><span class="s1">Should not succeed to make a HTTP Basic auth request with non-latin1 chars in credentials.</span><span class="dl">'</span>
        <span class="p">)</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="sr">/character/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">)).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
      <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="静态方法模块单元测试">静态方法模块单元测试</h2>

<p>静态方法模块为 <code class="language-plaintext highlighter-rouge">axios</code> 对象添加了 2 个静态方法，我们需要为其编写单元测试。</p>

<p><code class="language-plaintext highlighter-rouge">test/static.spec.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../src/index</span><span class="dl">'</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">promise</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should support all</span><span class="dl">'</span><span class="p">,</span> <span class="nx">done</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">fulfilled</span> <span class="o">=</span> <span class="kc">false</span>

    <span class="nx">axios</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="nx">arg</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">fulfilled</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">})</span>

    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">fulfilled</span><span class="p">).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
      <span class="nx">done</span><span class="p">()</span>
    <span class="p">},</span> <span class="mi">100</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should support spread</span><span class="dl">'</span><span class="p">,</span> <span class="nx">done</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">sum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">let</span> <span class="nx">fulfilled</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="kd">let</span> <span class="na">result</span><span class="p">:</span> <span class="kr">any</span>

    <span class="nx">axios</span>
      <span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="mi">123</span><span class="p">,</span> <span class="mi">456</span><span class="p">])</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span>
        <span class="nx">axios</span><span class="p">.</span><span class="nx">spread</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">sum</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span>
          <span class="nx">fulfilled</span> <span class="o">=</span> <span class="kc">true</span>
          <span class="k">return</span> <span class="dl">'</span><span class="s1">hello world</span><span class="dl">'</span>
        <span class="p">})</span>
      <span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">res</span>
      <span class="p">})</span>

    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">fulfilled</span><span class="p">).</span><span class="nx">toBeTruthy</span><span class="p">()</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">sum</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">123</span> <span class="o">+</span> <span class="mi">456</span><span class="p">)</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="dl">'</span><span class="s1">hello world</span><span class="dl">'</span><span class="p">)</span>
      <span class="nx">done</span><span class="p">()</span>
    <span class="p">},</span> <span class="mi">100</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="补充未覆盖的代码测试">补充未覆盖的代码测试</h2>

<p>我们发现，跑完测试后，仍有一些代码没有覆盖到测试，其中 <code class="language-plaintext highlighter-rouge">core/xhr.ts</code> 文件的第 43 行：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">responseType</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">responseType</span> <span class="o">=</span> <span class="nx">responseType</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我们并未在测试中设置过 <code class="language-plaintext highlighter-rouge">responseType</code>，因此我们在 <code class="language-plaintext highlighter-rouge">test/requests.spect.ts</code> 文件中补充相关测试：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">should support array buffer response</span><span class="dl">'</span><span class="p">,</span> <span class="nx">done</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">response</span><span class="p">:</span> <span class="nx">AxiosResponse</span>

  <span class="kd">function</span> <span class="nx">str2ab</span><span class="p">(</span><span class="na">str</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">buff</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ArrayBuffer</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint16Array</span><span class="p">(</span><span class="nx">buff</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">view</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">buff</span>
  <span class="p">}</span>

  <span class="nx">axios</span><span class="p">(</span><span class="dl">'</span><span class="s1">/foo</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">responseType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">arraybuffer</span><span class="dl">'</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">response</span> <span class="o">=</span> <span class="nx">data</span>
  <span class="p">})</span>

  <span class="nx">getAjaxRequest</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">request</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">({</span>
      <span class="na">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
      <span class="c1">// @ts-ignore</span>
      <span class="na">response</span><span class="p">:</span> <span class="nx">str2ab</span><span class="p">(</span><span class="dl">'</span><span class="s1">Hello world</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
      <span class="nx">done</span><span class="p">()</span>
    <span class="p">},</span> <span class="mi">100</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>另外我们发现 <code class="language-plaintext highlighter-rouge">core/xhr.ts</code> 文件的第 13 行：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">method</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">get</span><span class="dl">'</span>
</code></pre></div></div>

<p>分支没有测试完全。因为实际上代码执行到这的时候 <code class="language-plaintext highlighter-rouge">method</code> 是一定会有的，所以我们不必为其指定默认值，另外还需要在 <code class="language-plaintext highlighter-rouge">method!.toUpperCase()</code> 的时候使用非空断言。</p>

<p>同时<code class="language-plaintext highlighter-rouge">core/xhr.ts</code> 文件的第 66 行：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">responseData</span> <span class="o">=</span> <span class="nx">responseType</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">text</span><span class="dl">'</span> <span class="p">?</span> <span class="nx">request</span><span class="p">.</span><span class="nx">response</span> <span class="p">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">responseText</span>
</code></pre></div></div>

<p>分支也没有测试完全。这里我们应该先判断存在 <code class="language-plaintext highlighter-rouge">responseType</code> 存在的情况下再去和 <code class="language-plaintext highlighter-rouge">text</code> 做对比，需要修改逻辑：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">responseData</span> <span class="o">=</span> <span class="nx">responseType</span> <span class="o">&amp;&amp;</span> <span class="nx">responseType</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">text</span><span class="dl">'</span> <span class="p">?</span> <span class="nx">request</span><span class="p">.</span><span class="nx">response</span> <span class="p">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">responseText</span>
</code></pre></div></div>

<p>这样再次跑测试，就覆盖了所有的分支。</p>

<p>到此为止，除了我们之前说的 <code class="language-plaintext highlighter-rouge">helpers/error.ts</code> 模块中对于 <code class="language-plaintext highlighter-rouge">super</code> 的测试的分支覆盖率没达到 100%，其它模块均达到 100% 的测试覆盖率。</p>

<p>有些有强迫症的同学可能会觉得，能不能通过某种手段让它的覆盖率达到 100% 呢，这里其实有一个奇技淫巧，在 <code class="language-plaintext highlighter-rouge">helpers/error.ts</code> 文件的 <code class="language-plaintext highlighter-rouge">constructor</code> 函数上方加一个 <code class="language-plaintext highlighter-rouge">/* istanbul ignore next */</code> 注释，这样其实相当于忽略了整个构造函数的测试，这样我们就可以达到 100% 的覆盖率了。</p>

<p><code class="language-plaintext highlighter-rouge">/* istanbul ignore next */</code> 在我们去阅读一些开源代码的时候经常会遇到，主要用途就是用来忽略测试用的，这个技巧不可滥用，除非你明确的知道这段代码不需要测试，否则你不应该使用它。滥用就失去了单元测试的意义了。</p>

<p>至此，我们就完成了整个 <code class="language-plaintext highlighter-rouge">ts-axios</code> 库的测试了，我们也成功地让测试覆盖率达到目标 99% 以上。下一章我会教大家如果打包构建和发布我们的 <code class="language-plaintext highlighter-rouge">ts-axios</code> 库。</p>
