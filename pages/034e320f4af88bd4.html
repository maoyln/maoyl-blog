<h1 id="扩展接口">扩展接口</h1>

<h2 id="需求分析">需求分析</h2>

<p>为了用户更加方便地使用 axios 发送请求，我们可以为所有支持请求方法扩展一些接口：</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">axios.request(config)</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">axios.get(url[, config])</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">axios.delete(url[, config])</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">axios.head(url[, config])</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">axios.options(url[, config])</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">axios.post(url[, data[, config]])</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">axios.put(url[, data[, config]])</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">axios.patch(url[, data[, config]])</code></p>
  </li>
</ul>

<p>如果使用了这些方法，我们就不必在 <code class="language-plaintext highlighter-rouge">config</code> 中指定 <code class="language-plaintext highlighter-rouge">url</code>、<code class="language-plaintext highlighter-rouge">method</code>、<code class="language-plaintext highlighter-rouge">data</code> 这些属性了。</p>

<p>从需求上来看，<code class="language-plaintext highlighter-rouge">axios</code> 不再单单是一个方法，更像是一个混合对象，本身是一个方法，又有很多方法属性，接下来我们就来实现这个混合对象。</p>

<h2 id="接口类型定义">接口类型定义</h2>

<p>根据需求分析，混合对象 <code class="language-plaintext highlighter-rouge">axios</code> 本身是一个函数，我们再实现一个包括它属性方法的类，然后把这个类的原型属性和自身属性再拷贝到 <code class="language-plaintext highlighter-rouge">axios</code> 上。</p>

<p>我们先来给 <code class="language-plaintext highlighter-rouge">axios</code> 混合对象定义接口：</p>

<p><code class="language-plaintext highlighter-rouge">types/index.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kr">interface</span> <span class="nx">Axios</span> <span class="p">{</span>
  <span class="nx">request</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span>

  <span class="kd">get</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span>

  <span class="k">delete</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span>

  <span class="nx">head</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span>

  <span class="nx">options</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span>

  <span class="nx">post</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">data</span><span class="p">?:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span>

  <span class="nx">put</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">data</span><span class="p">?:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span>

  <span class="nx">patch</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">data</span><span class="p">?:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">AxiosInstance</span> <span class="kd">extends</span> <span class="nx">Axios</span> <span class="p">{</span>
  <span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">AxiosRequestConfig</span> <span class="p">{</span>
  <span class="nl">url</span><span class="p">?:</span> <span class="kr">string</span>
  <span class="c1">// ...</span>
<span class="p">}</span>

</code></pre></div></div>

<p>首先定义一个 <code class="language-plaintext highlighter-rouge">Axios</code> 类型接口，它描述了 <code class="language-plaintext highlighter-rouge">Axios</code> 类中的公共方法，接着定义了 <code class="language-plaintext highlighter-rouge">AxiosInstance</code> 接口继承 <code class="language-plaintext highlighter-rouge">Axios</code>，它就是一个混合类型的接口。</p>

<p>另外 <code class="language-plaintext highlighter-rouge">AxiosRequestConfig</code> 类型接口中的 <code class="language-plaintext highlighter-rouge">url</code> 属性变成了可选属性。</p>

<h2 id="创建-axios-类">创建 Axios 类</h2>

<p>我们创建一个 <code class="language-plaintext highlighter-rouge">Axios</code> 类，来实现接口定义的公共方法。我们创建了一个 <code class="language-plaintext highlighter-rouge">core</code> 目录，用来存放发送请求核心流程的代码。我们在 <code class="language-plaintext highlighter-rouge">core</code> 目录下创建 <code class="language-plaintext highlighter-rouge">Axios.ts</code> 文件。</p>

<p><code class="language-plaintext highlighter-rouge">core/Axios.ts</code></p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">AxiosRequestConfig</span><span class="p">,</span> <span class="nx">AxiosPromise</span><span class="p">,</span> <span class="nx">Method</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../types</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">dispatchRequest</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./dispatchRequest</span><span class="dl">'</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">class</span> <span class="nx">Axios</span> <span class="p">{</span>
  <span class="nx">request</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">dispatchRequest</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">get</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_requestMethodWithoutData</span><span class="p">(</span><span class="dl">'</span><span class="s1">get</span><span class="dl">'</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">delete</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_requestMethodWithoutData</span><span class="p">(</span><span class="dl">'</span><span class="s1">delete</span><span class="dl">'</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">head</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_requestMethodWithoutData</span><span class="p">(</span><span class="dl">'</span><span class="s1">head</span><span class="dl">'</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">options</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_requestMethodWithoutData</span><span class="p">(</span><span class="dl">'</span><span class="s1">options</span><span class="dl">'</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">post</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">data</span><span class="p">?:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_requestMethodWithData</span><span class="p">(</span><span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">put</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">data</span><span class="p">?:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_requestMethodWithData</span><span class="p">(</span><span class="dl">'</span><span class="s1">put</span><span class="dl">'</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">patch</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">data</span><span class="p">?:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_requestMethodWithData</span><span class="p">(</span><span class="dl">'</span><span class="s1">patch</span><span class="dl">'</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">_requestMethodWithoutData</span><span class="p">(</span><span class="nx">method</span><span class="p">:</span> <span class="nx">Method</span><span class="p">,</span> <span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span>
      <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">config</span> <span class="o">||</span> <span class="p">{},</span> <span class="p">{</span>
        <span class="nx">method</span><span class="p">,</span>
        <span class="nx">url</span>
      <span class="p">})</span>
    <span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">_requestMethodWithData</span><span class="p">(</span><span class="nx">method</span><span class="p">:</span> <span class="nx">Method</span><span class="p">,</span> <span class="nx">url</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">data</span><span class="p">?:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span>
      <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">config</span> <span class="o">||</span> <span class="p">{},</span> <span class="p">{</span>
        <span class="nx">method</span><span class="p">,</span>
        <span class="nx">url</span><span class="p">,</span>
        <span class="nx">data</span>
      <span class="p">})</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>其中 <code class="language-plaintext highlighter-rouge">request</code> 方法的功能和我们之前的 <code class="language-plaintext highlighter-rouge">axios</code> 函数功能是一致。<code class="language-plaintext highlighter-rouge">axios</code> 函数的功能就是发送请求，基于模块化编程的思想，我们把这部分功能抽出一个单独的模块，在 <code class="language-plaintext highlighter-rouge">core</code> 目录下创建 <code class="language-plaintext highlighter-rouge">dispatchRequest</code> 方法，把之前 <code class="language-plaintext highlighter-rouge">axios.ts</code> 的相关代码拷贝过去。另外我们把 <code class="language-plaintext highlighter-rouge">xhr.ts</code> 文件也迁移到 <code class="language-plaintext highlighter-rouge">core</code> 目录下。</p>

<p><code class="language-plaintext highlighter-rouge">core/dispatchRequest.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">AxiosPromise</span><span class="p">,</span> <span class="nx">AxiosRequestConfig</span><span class="p">,</span> <span class="nx">AxiosResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../types</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">xhr</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./xhr</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">buildURL</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../helpers/url</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">transformRequest</span><span class="p">,</span> <span class="nx">transformResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../helpers/data</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">processHeaders</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../helpers/headers</span><span class="dl">'</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">dispatchRequest</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosPromise</span> <span class="p">{</span>
  <span class="nx">processConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">xhr</span><span class="p">(</span><span class="nx">config</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">transformResponseData</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">processConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">transformURL</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="nx">transformHeaders</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">transformRequestData</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">transformURL</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="kr">string</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">params</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">config</span>
  <span class="k">return</span> <span class="nx">buildURL</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">transformRequestData</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="kr">any</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">transformRequest</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">transformHeaders</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">data</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">config</span>
  <span class="k">return</span> <span class="nx">processHeaders</span><span class="p">(</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">transformResponseData</span><span class="p">(</span><span class="nx">res</span><span class="p">:</span> <span class="nx">AxiosResponse</span><span class="p">):</span> <span class="nx">AxiosResponse</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">transformResponse</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">res</span>
<span class="p">}</span>
</code></pre></div></div>

<p>回到 <code class="language-plaintext highlighter-rouge">Axios.ts</code> 文件，对于 <code class="language-plaintext highlighter-rouge">get</code>、<code class="language-plaintext highlighter-rouge">delete</code>、<code class="language-plaintext highlighter-rouge">head</code>、<code class="language-plaintext highlighter-rouge">options</code>、<code class="language-plaintext highlighter-rouge">post</code>、<code class="language-plaintext highlighter-rouge">patch</code>、<code class="language-plaintext highlighter-rouge">put</code> 这些方法，都是对外提供的语法糖，内部都是通过调用 <code class="language-plaintext highlighter-rouge">request</code> 方法实现发送请求，只不过在调用之前对 <code class="language-plaintext highlighter-rouge">config</code> 做了一层合并处理。</p>

<h2 id="混合对象实现">混合对象实现</h2>

<p>混合对象实现思路很简单，首先这个对象是一个函数，其次这个对象要包括 <code class="language-plaintext highlighter-rouge">Axios</code> 类的所有原型属性和实例属性，我们首先来实现一个辅助函数 <code class="language-plaintext highlighter-rouge">extend</code>。</p>

<p><code class="language-plaintext highlighter-rouge">helpers/util.ts</code></p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">extend</span><span class="o">&lt;</span><span class="nx">T</span><span class="p">,</span> <span class="nx">U</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">to</span><span class="p">:</span> <span class="nx">T</span><span class="p">,</span> <span class="k">from</span><span class="p">:</span> <span class="nx">U</span><span class="p">):</span> <span class="nx">T</span> <span class="o">&amp;</span> <span class="nx">U</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="k">from</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">;(</span><span class="nx">to</span> <span class="k">as</span> <span class="nx">T</span> <span class="o">&amp;</span> <span class="nx">U</span><span class="p">)[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">from</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">as</span> <span class="kr">any</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">to</span> <span class="k">as</span> <span class="nx">T</span> <span class="o">&amp;</span> <span class="nx">U</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">extend</code> 方法的实现用到了交叉类型，并且用到了类型断言。<code class="language-plaintext highlighter-rouge">extend</code> 的最终目的是把 <code class="language-plaintext highlighter-rouge">from</code> 里的属性都扩展到 <code class="language-plaintext highlighter-rouge">to</code> 中，包括原型上的属性。</p>

<p>我们接下来对 <code class="language-plaintext highlighter-rouge">axios.ts</code> 文件做修改，我们用工厂模式去创建一个 <code class="language-plaintext highlighter-rouge">axios</code> 混合对象。</p>

<p><code class="language-plaintext highlighter-rouge">axios.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">AxiosInstance</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./types</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">Axios</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./core/Axios</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">extend</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./helpers/util</span><span class="dl">'</span>

<span class="kd">function</span> <span class="nx">createInstance</span><span class="p">():</span> <span class="nx">AxiosInstance</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Axios</span><span class="p">()</span>
  <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">Axios</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>

  <span class="nx">extend</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">instance</span> <span class="k">as</span> <span class="nx">AxiosInstance</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">axios</span> <span class="o">=</span> <span class="nx">createInstance</span><span class="p">()</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">axios</span>
</code></pre></div></div>

<p>在 <code class="language-plaintext highlighter-rouge">createInstance</code> 工厂函数的内部，我们首先实例化了 <code class="language-plaintext highlighter-rouge">Axios</code> 实例 <code class="language-plaintext highlighter-rouge">context</code>，接着创建<code class="language-plaintext highlighter-rouge">instance</code> 指向 <code class="language-plaintext highlighter-rouge">Axios.prototype.request</code> 方法，并绑定了上下文 <code class="language-plaintext highlighter-rouge">context</code>；接着通过 <code class="language-plaintext highlighter-rouge">extend</code> 方法把 <code class="language-plaintext highlighter-rouge">context</code> 中的原型方法和实例方法全部拷贝到 <code class="language-plaintext highlighter-rouge">instance</code> 上，这样就实现了一个混合对象：<code class="language-plaintext highlighter-rouge">instance</code> 本身是一个函数，又拥有了 <code class="language-plaintext highlighter-rouge">Axios</code> 类的所有原型和实例属性，最终把这个 <code class="language-plaintext highlighter-rouge">instance</code> 返回。由于这里 <code class="language-plaintext highlighter-rouge">TypeScript</code> 不能正确推断 <code class="language-plaintext highlighter-rouge">instance</code> 的类型，我们把它断言成 <code class="language-plaintext highlighter-rouge">AxiosInstance</code> 类型。</p>

<p>这样我们就可以通过 <code class="language-plaintext highlighter-rouge">createInstance</code> 工厂函数创建了 <code class="language-plaintext highlighter-rouge">axios</code>，当直接调用 <code class="language-plaintext highlighter-rouge">axios</code> 方法就相当于执行了 <code class="language-plaintext highlighter-rouge">Axios</code> 类的 <code class="language-plaintext highlighter-rouge">request</code> 方法发送请求，当然我们也可以调用 <code class="language-plaintext highlighter-rouge">axios.get</code>、<code class="language-plaintext highlighter-rouge">axios.post</code> 等方法。</p>

<h2 id="demo-编写">demo 编写</h2>

<p>在 <code class="language-plaintext highlighter-rouge">examples</code> 目录下创建 <code class="language-plaintext highlighter-rouge">extend</code> 目录，在 <code class="language-plaintext highlighter-rouge">extend</code> 目录下创建 <code class="language-plaintext highlighter-rouge">index.html</code>:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Extend example<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/__build__/extend.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>接着创建 <code class="language-plaintext highlighter-rouge">app.ts</code> 作为入口文件：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../src/index</span><span class="dl">'</span>

<span class="nx">axios</span><span class="p">({</span>
  <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/extend/post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">msg</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hi</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="nx">axios</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
  <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/extend/post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">msg</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/extend/get</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">axios</span><span class="p">.</span><span class="nx">options</span><span class="p">(</span><span class="dl">'</span><span class="s1">/extend/options</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">axios</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">'</span><span class="s1">/extend/delete</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">axios</span><span class="p">.</span><span class="nx">head</span><span class="p">(</span><span class="dl">'</span><span class="s1">/extend/head</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/extend/post</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">'</span><span class="s1">post</span><span class="dl">'</span> <span class="p">})</span>

<span class="nx">axios</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="dl">'</span><span class="s1">/extend/put</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">'</span><span class="s1">put</span><span class="dl">'</span> <span class="p">})</span>

<span class="nx">axios</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="dl">'</span><span class="s1">/extend/patch</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">'</span><span class="s1">patch</span><span class="dl">'</span> <span class="p">})</span>
</code></pre></div></div>

<p>然后在命令行运行 <code class="language-plaintext highlighter-rouge">npm run dev</code>，接着打开 chrome 浏览器，访问 <code class="language-plaintext highlighter-rouge">http://localhost:8080/</code> 即可访问我们的 demo 了，我们点到 <code class="language-plaintext highlighter-rouge">Extend</code> 目录下，通过开发者工具的 network 部分我们可以看到每个请求的发送情况。</p>

<p>至此我们支持了对 <code class="language-plaintext highlighter-rouge">axios</code> API 的扩展，把它变成了一个混合对象。官方的 <code class="language-plaintext highlighter-rouge">axios</code> 实例除了支持了 <code class="language-plaintext highlighter-rouge">axios(config)</code>，还支持了传入 2 个参数 <code class="language-plaintext highlighter-rouge">axios(url, config)</code>，这里就涉及到函数重载的概念了，下一节我们来实现这个 feature。</p>
