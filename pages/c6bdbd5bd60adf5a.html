<h1 id="引用-ts-axios-库">引用 ts-axios 库</h1>

<h2 id="在-ts-项目中引用">在 TS 项目中引用</h2>

<p>我们借助于 <a href="https://cli.vuejs.org/">vue-cli</a> 脚手架创建一个 TypeScript 的 Vue 项目，然后我们把 Vue 官网上一段使用 axios 发请求的 <a href="https://cn.vuejs.org/v2/guide/computed.html#%E4%BE%A6%E5%90%AC%E5%99%A8">demo</a> 代码抄过来。</p>

<p>我们需要先执行 <code class="language-plaintext highlighter-rouge">npm install ts-axios-new</code> 安装 <code class="language-plaintext highlighter-rouge">ts-axios</code> 库。</p>

<p><code class="language-plaintext highlighter-rouge">HelloWorld.vue</code></p>

<div class="language-vue highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;</span><span class="k">template</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"hello"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      Ask a yes/no question:
      <span class="nt">&lt;input</span> <span class="na">v-model=</span><span class="s">"question"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/</span><span class="k">template</span><span class="nt">&gt;</span>

<span class="nt">&lt;</span><span class="k">script</span> <span class="na">lang=</span><span class="s">"ts"</span><span class="nt">&gt;</span>
  <span class="k">import</span> <span class="nx">Vue</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">vue</span><span class="dl">'</span>
  <span class="k">import</span> <span class="nx">_</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">lodash</span><span class="dl">'</span>
  <span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">ts-axios-new</span><span class="dl">'</span>

  <span class="k">export</span> <span class="k">default</span> <span class="nx">Vue</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">HelloWorld</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">data</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="na">question</span><span class="p">:</span> <span class="dl">''</span><span class="p">,</span>
        <span class="na">answer</span><span class="p">:</span> <span class="dl">'</span><span class="s1">I cannot give you an answer until you ask a question!</span><span class="dl">'</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">created</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">debouncedGetAnswer</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">debounce</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getAnswer</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="na">methods</span><span class="p">:</span> <span class="p">{</span>
      <span class="nx">debouncedGetAnswer</span> <span class="p">()</span> <span class="p">{</span>
        <span class="c1">// do nothing</span>
      <span class="p">},</span>
      <span class="nx">getAnswer</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">?</span><span class="dl">'</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">answer</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Questions usually contain a question mark. -)</span><span class="dl">'</span>
          <span class="k">return</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">answer</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Thinking...</span><span class="dl">'</span>
        <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>
        <span class="nx">instance</span><span class="p">.</span><span class="nx">interceptors</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">config</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">config</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">_t</span><span class="p">:</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">config</span>
        <span class="p">})</span>

        <span class="nx">instance</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://yesno.wtf/api</span><span class="dl">'</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">answer</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">capitalize</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">answer</span><span class="p">)</span>
          <span class="p">})</span>
          <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">answer</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Error! Could not reach the API. </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">error</span>
          <span class="p">})</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="na">watch</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">question</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="na">newQuestion</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="na">oldQuestion</span><span class="p">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">answer</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Waiting for you to stop typing...</span><span class="dl">'</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">debouncedGetAnswer</span><span class="p">()</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="nt">&lt;/</span><span class="k">script</span><span class="nt">&gt;</span>

<span class="c">&lt;!-- Add "scoped" attribute to limit CSS to this component only --&gt;</span>
<span class="nt">&lt;</span><span class="k">style</span> <span class="na">scoped</span><span class="nt">&gt;</span>
  <span class="nt">h3</span> <span class="p">{</span>
    <span class="nl">margin</span><span class="p">:</span> <span class="m">40px</span> <span class="m">0</span> <span class="m">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nt">ul</span> <span class="p">{</span>
    <span class="nl">list-style-type</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nt">li</span> <span class="p">{</span>
    <span class="nl">display</span><span class="p">:</span> <span class="n">inline-block</span><span class="p">;</span>
    <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span> <span class="m">10px</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nt">a</span> <span class="p">{</span>
    <span class="nl">color</span><span class="p">:</span> <span class="m">#42b983</span><span class="p">;</span>
  <span class="p">}</span>
<span class="nt">&lt;/</span><span class="k">style</span><span class="nt">&gt;</span>
</code></pre></div></div>
<p>这段代码主要是提供了一个 <code class="language-plaintext highlighter-rouge">input</code> 输入框，绑定了 <code class="language-plaintext highlighter-rouge">question</code> 变量，当我们输入的时候，会触发 <code class="language-plaintext highlighter-rouge">question</code> 的变化，执行 <code class="language-plaintext highlighter-rouge">watch question</code> 中的逻辑，执行 <code class="language-plaintext highlighter-rouge">this.debouncedGetAnswer</code> 方法，实际上就是 <code class="language-plaintext highlighter-rouge">debounce</code> 执行了 <code class="language-plaintext highlighter-rouge">getAnswer</code> 方法，发送请求。</p>

<p>我们通过 <code class="language-plaintext highlighter-rouge">import axios from 'ts-axios-new'
</code> 去加载 <code class="language-plaintext highlighter-rouge">ts-axios</code> 库，实际上就是引入了 <code class="language-plaintext highlighter-rouge">node_modules/ts-axios-new/dist/axios.es5.js</code>，因为 <code class="language-plaintext highlighter-rouge">ts-axios-new</code> 的 <code class="language-plaintext highlighter-rouge">package.json</code> 文件中配置的 <code class="language-plaintext highlighter-rouge">module</code> 字段是 <code class="language-plaintext highlighter-rouge">dist/axios.es5.js</code>，在 <code class="language-plaintext highlighter-rouge">webpack</code> 中优先 <code class="language-plaintext highlighter-rouge">import</code> 优先会找 <code class="language-plaintext highlighter-rouge">module</code> 字段，其次是 <code class="language-plaintext highlighter-rouge">main</code> 字段。</p>

<blockquote>
  <p>小技巧：当我们引入某个库运行时出现问题时候，我们就可以调试 node_modules 中对应引入的代码。</p>
</blockquote>

<p>注意我们这里先使用了 <code class="language-plaintext highlighter-rouge">axios.create()</code> 方法创建了一个 <code class="language-plaintext highlighter-rouge">instance</code>，然后添加了一个请求拦截器，会在每次发送请求前，添加了一个 <code class="language-plaintext highlighter-rouge">_t</code> 参数，值为时间戳。然后执行 <code class="language-plaintext highlighter-rouge">instance.get</code> 发送一个请求。</p>

<p>我们可以看到整个 demo 是可以正常运行的，并且没有任何类型相关的问题，说明我们的库打包后的代码和类型声明文件都是没有问题的。</p>

<h2 id="在-js-项目中引用">在 JS 项目中引用</h2>

<p>我们编写的 TS 库仍然可以被纯 JS 的项目引用，这次我们来修改<a href="https://coding.imooc.com/class/74.html">《Vue.js2.5+cube-ui重构饿了么App》</a>课程的代码，把之前对 <code class="language-plaintext highlighter-rouge">axios</code> 的引用改成对 <code class="language-plaintext highlighter-rouge">ts-axios-new</code> 的引用。课程源码是开源的，所以没购买课程的小伙伴也可以去 <a href="https://github.com/ustbhuangyi/vue-sell">GitHub</a> 下载。</p>

<p>我们需要先执行 <code class="language-plaintext highlighter-rouge">npm install ts-axios-new</code> 安装 <code class="language-plaintext highlighter-rouge">ts-axios</code> 库，然后修改代码。</p>

<p><code class="language-plaintext highlighter-rouge">api/helpers.js</code>：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">ts-axios-new</span><span class="dl">'</span>

<span class="kd">const</span> <span class="nx">urlMap</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">development</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">production</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://ustbhuangyi.com/sell/</span><span class="dl">'</span>
<span class="p">}</span>
<span class="kd">const</span> <span class="nx">baseUrl</span> <span class="o">=</span> <span class="nx">urlMap</span><span class="p">[</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span><span class="p">]</span>
<span class="kd">const</span> <span class="nx">ERR_OK</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">export</span> <span class="kd">function</span> <span class="kd">get</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">params</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">baseUrl</span> <span class="o">+</span> <span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">params</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span><span class="nx">errno</span><span class="p">,</span> <span class="nx">data</span><span class="p">}</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">errno</span> <span class="o">===</span> <span class="nx">ERR_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">data</span>
      <span class="p">}</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>只需要把 <code class="language-plaintext highlighter-rouge">import axios from 'axios'</code> 修改为 <code class="language-plaintext highlighter-rouge">import axios from 'ts-axios-new'</code> 即可。</p>

<p>接着运行项目，我们发现项目可以成功运行，因为我们实现了<code class="language-plaintext highlighter-rouge">axios</code> 在浏览器端的所有功能，所以可以放心的做替换。</p>

<p>至此，我们就完成了 <code class="language-plaintext highlighter-rouge">ts-axios</code> 库的开发、测试、编译、发布和引用。课程到这里也就告一段落了，下一章我们会对整个课程做总结与展望。</p>
