<h1 id="合并配置的设计与实现">合并配置的设计与实现</h1>

<h2 id="需求分析">需求分析</h2>

<p>在之前的章节我们了解到，在发送请求的时候可以传入一个配置，来决定请求的不同行为。我们也希望 <code class="language-plaintext highlighter-rouge">ts-axios</code> 可以有默认配置，定义一些默认的行为。这样在发送每个请求，用户传递的配置可以和默认配置做一层合并。</p>

<p>和官网 <code class="language-plaintext highlighter-rouge">axios</code> 库保持一致，我们给 <code class="language-plaintext highlighter-rouge">axios</code> 对象添加一个 <code class="language-plaintext highlighter-rouge">defaults</code> 属性，表示默认配置，你甚至可以直接修改这些默认配置：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">common</span><span class="p">[</span><span class="dl">'</span><span class="s1">test</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">123</span>
<span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">post</span><span class="p">[</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">application/x-www-form-urlencoded</span><span class="dl">'</span>
<span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="mi">2000</span>
</code></pre></div></div>

<p>其中对于 <code class="language-plaintext highlighter-rouge">headers</code> 的默认配置支持 <code class="language-plaintext highlighter-rouge">common</code> 和一些请求 <code class="language-plaintext highlighter-rouge">method</code> 字段，<code class="language-plaintext highlighter-rouge">common</code> 表示对于任何类型的请求都要添加该属性，而 <code class="language-plaintext highlighter-rouge">method</code> 表示只有该类型请求方法才会添加对应的属性。</p>

<p>在上述例子中，我们会默认为所有请求的 <code class="language-plaintext highlighter-rouge">header</code> 添加 <code class="language-plaintext highlighter-rouge">test</code> 属性，会默认为 <code class="language-plaintext highlighter-rouge">post</code> 请求的 <code class="language-plaintext highlighter-rouge">header</code> 添加 <code class="language-plaintext highlighter-rouge">Content-Type</code> 属性。</p>

<h2 id="默认配置">默认配置</h2>

<h3 id="默认配置定义">默认配置定义</h3>

<p>接下来，我们先实现默认配置</p>

<p><code class="language-plaintext highlighter-rouge">defaults.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">AxiosRequestConfig</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./types</span><span class="dl">'</span>

<span class="kd">const</span> <span class="nx">defaults</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">get</span><span class="dl">'</span><span class="p">,</span>

  <span class="na">timeout</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>

  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">common</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">Accept</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json, text/plain, */*</span><span class="dl">'</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">methodsNoData</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">delete</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">get</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">head</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">options</span><span class="dl">'</span><span class="p">]</span>

<span class="nx">methodsNoData</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">method</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">})</span>

<span class="kd">const</span> <span class="nx">methodsWithData</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">put</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">patch</span><span class="dl">'</span><span class="p">]</span>

<span class="nx">methodsWithData</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">method</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/x-www-form-urlencoded</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">defaults</span>
</code></pre></div></div>

<p>我们定义了 <code class="language-plaintext highlighter-rouge">defaults</code> 常量，它包含默认请求的方法、超时时间，以及 <code class="language-plaintext highlighter-rouge">headers</code> 配置。</p>

<p>未来我们会根据新的需求添加更多的默认配置。</p>

<h3 id="添加到-axios-对象中">添加到 axios 对象中</h3>

<p>根据需求，我们要给 <code class="language-plaintext highlighter-rouge">axios</code> 对象添加一个 <code class="language-plaintext highlighter-rouge">defaults</code> 属性，表示默认配置：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="k">default</span> <span class="kd">class</span> <span class="nx">Axios</span> <span class="p">{</span>
  <span class="nl">defaults</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span>
  <span class="nx">interceptors</span><span class="p">:</span> <span class="nx">Interceptors</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="nx">initConfig</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">defaults</span> <span class="o">=</span> <span class="nx">initConfig</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">interceptors</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">request</span><span class="p">:</span> <span class="k">new</span> <span class="nx">InterceptorManager</span><span class="o">&lt;</span><span class="nx">AxiosRequestConfig</span><span class="o">&gt;</span><span class="p">(),</span>
      <span class="na">response</span><span class="p">:</span> <span class="k">new</span> <span class="nx">InterceptorManager</span><span class="o">&lt;</span><span class="nx">AxiosResponse</span><span class="o">&gt;</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我们给 <code class="language-plaintext highlighter-rouge">Axios</code> 类添加一个 <code class="language-plaintext highlighter-rouge">defaults</code> 成员属性，并且让 <code class="language-plaintext highlighter-rouge">Axios</code> 的构造函数接受一个 <code class="language-plaintext highlighter-rouge">initConfig</code> 对象，把 <code class="language-plaintext highlighter-rouge">initConfig</code> 赋值给 <code class="language-plaintext highlighter-rouge">this.defaults</code>。</p>

<p>接着修改 <code class="language-plaintext highlighter-rouge">createInstance</code> 方法，支持传入 <code class="language-plaintext highlighter-rouge">config</code> 对象。</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">defaults</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./defaults</span><span class="dl">'</span>

<span class="kd">function</span> <span class="nx">createInstance</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosStatic</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Axios</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">Axios</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>

  <span class="c1">// extend(instance, Axios.prototype, context)</span>

  <span class="nx">extend</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">instance</span> <span class="k">as</span> <span class="nx">AxiosStatic</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">axios</span> <span class="o">=</span> <span class="nx">createInstance</span><span class="p">(</span><span class="nx">defaults</span><span class="p">)</span>
</code></pre></div></div>

<p>这样我们就可以在执行 <code class="language-plaintext highlighter-rouge">createInstance</code> 创建 <code class="language-plaintext highlighter-rouge">axios</code> 对象的时候，把默认配置传入了。</p>

<h2 id="配置合并及策略">配置合并及策略</h2>

<p>定义了默认配置后，我们发送每个请求的时候需要把自定义配置和默认配置做合并，它并不是简单的 2 个普通对象的合并，对于不同的字段合并，会有不同的合并策略。举个例子：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">config1</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">get</span><span class="dl">'</span><span class="p">,</span>

  <span class="na">timeout</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>

  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">common</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">Accept</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json, text/plain, */*</span><span class="dl">'</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">config2</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/config/post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">a</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">},</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">test</span><span class="p">:</span> <span class="dl">'</span><span class="s1">321</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">merged</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/config/post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">a</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">},</span>
  <span class="na">timeout</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">common</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">Accept</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json, text/plain, */*</span><span class="dl">'</span>
    <span class="p">}</span>
    <span class="nl">test</span><span class="p">:</span> <span class="dl">'</span><span class="s1">321</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我们在 <code class="language-plaintext highlighter-rouge">core/mergeConfig.ts</code> 中实现合并方法。</p>

<h3 id="合并方法">合并方法</h3>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">mergeConfig</span><span class="p">(</span>
  <span class="nx">config1</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">,</span>
  <span class="nx">config2</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span>
<span class="p">):</span> <span class="nx">AxiosRequestConfig</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config2</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">config2</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">config2</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">mergeField</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">config1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config2</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
      <span class="nx">mergeField</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">mergeField</span><span class="p">(</span><span class="nx">key</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">strat</span> <span class="o">=</span> <span class="nx">strats</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">||</span> <span class="nx">defaultStrat</span>
    <span class="nx">config</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">strat</span><span class="p">(</span><span class="nx">config1</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">config2</span><span class="o">!</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">config</span>
<span class="p">}</span>
</code></pre></div></div>

<p>合并方法的整体思路就是对 <code class="language-plaintext highlighter-rouge">config1</code> 和 <code class="language-plaintext highlighter-rouge">config2</code> 中的属性遍历，执行 <code class="language-plaintext highlighter-rouge">mergeField</code> 方法做合并，这里 <code class="language-plaintext highlighter-rouge">config1</code> 代表默认配置，<code class="language-plaintext highlighter-rouge">config2</code> 代表自定义配置。</p>

<p>遍历过程中，我们会通过 <code class="language-plaintext highlighter-rouge">config2[key]</code> 这种索引的方式访问，所以需要给 <code class="language-plaintext highlighter-rouge">AxiosRequestConfig</code> 的接口定义添加一个字符串索引签名：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kr">interface</span> <span class="nx">AxiosRequestConfig</span> <span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="p">[</span><span class="nx">propName</span><span class="p">:</span> <span class="kr">string</span><span class="p">]:</span> <span class="kr">any</span>
<span class="p">}</span>
</code></pre></div></div>

<p>在 <code class="language-plaintext highlighter-rouge">mergeField</code> 方法中，我们会针对不同的属性使用不同的合并策略。</p>

<h3 id="默认合并策略">默认合并策略</h3>

<p>这是大部分属性的合并策略，如下：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">defaultStrat</span><span class="p">(</span><span class="nx">val1</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">val2</span><span class="p">:</span> <span class="kr">any</span><span class="p">):</span> <span class="kr">any</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">typeof</span> <span class="nx">val2</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span> <span class="p">?</span> <span class="nx">val2</span> <span class="p">:</span> <span class="nx">val1</span>
<span class="p">}</span>
</code></pre></div></div>

<p>它很简单，如果有 <code class="language-plaintext highlighter-rouge">val2</code> 则返回 <code class="language-plaintext highlighter-rouge">val2</code>，否则返回 <code class="language-plaintext highlighter-rouge">val1</code>，也就是如果自定义配置中定义了某个属性，就采用自定义的，否则就用默认配置。</p>

<h3 id="只接受自定义配置合并策略">只接受自定义配置合并策略</h3>

<p>对于一些属性如 <code class="language-plaintext highlighter-rouge">url</code>、<code class="language-plaintext highlighter-rouge">params</code>、<code class="language-plaintext highlighter-rouge">data</code>，合并策略如下：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">fromVal2Strat</span><span class="p">(</span><span class="nx">val1</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">val2</span><span class="p">:</span> <span class="kr">any</span><span class="p">):</span> <span class="kr">any</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">val2</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">val2</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">stratKeysFromVal2</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">url</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">params</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">]</span>

<span class="nx">stratKeysFromVal2</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">strats</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fromVal2Strat</span>
<span class="p">})</span>
</code></pre></div></div>

<p>因为对于 <code class="language-plaintext highlighter-rouge">url</code>、<code class="language-plaintext highlighter-rouge">params</code>、<code class="language-plaintext highlighter-rouge">data</code> 这些属性，默认配置显然是没有意义的，它们是和每个请求强相关的，所以我们只从自定义配置中获取。</p>

<h3 id="复杂对象合并策略">复杂对象合并策略</h3>

<p>对于一些属性如 <code class="language-plaintext highlighter-rouge">headers</code>，合并策略如下：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">deepMergeStrat</span><span class="p">(</span><span class="nx">val1</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">val2</span><span class="p">:</span> <span class="kr">any</span><span class="p">):</span> <span class="kr">any</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">isPlainObject</span><span class="p">(</span><span class="nx">val2</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">deepMerge</span><span class="p">(</span><span class="nx">val1</span><span class="p">,</span> <span class="nx">val2</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">val2</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">val2</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isPlainObject</span><span class="p">(</span><span class="nx">val1</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">deepMerge</span><span class="p">(</span><span class="nx">val1</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">val1</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">val1</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">stratKeysDeepMerge</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">headers</span><span class="dl">'</span><span class="p">]</span>

<span class="nx">stratKeysDeepMerge</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">strats</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">deepMergeStrat</span>
<span class="p">})</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">helpers/util.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">deepMerge</span><span class="p">(...</span><span class="nx">objs</span><span class="p">:</span> <span class="kr">any</span><span class="p">[]):</span> <span class="kr">any</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>

  <span class="nx">objs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">obj</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isPlainObject</span><span class="p">(</span><span class="nx">val</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">isPlainObject</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">deepMerge</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">val</span><span class="p">)</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">deepMerge</span><span class="p">({},</span> <span class="nx">val</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">})</span>

  <span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span>
</code></pre></div></div>

<p>对于 <code class="language-plaintext highlighter-rouge">headers</code> 这类的复杂对象属性，我们需要使用深拷贝的方式，同时也处理了其它一些情况，因为它们也可能是一个非对象的普通值。未来我们讲到认证授权的时候，<code class="language-plaintext highlighter-rouge">auth</code> 属性也是这个合并策略。</p>

<p>最后我们在 <code class="language-plaintext highlighter-rouge">request</code> 方法里添加合并配置的逻辑：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">config</span> <span class="o">=</span> <span class="nx">mergeConfig</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">defaults</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="flatten-headers">flatten headers</h2>

<p>经过合并后的配置中的 <code class="language-plaintext highlighter-rouge">headers</code> 是一个复杂对象，多了 <code class="language-plaintext highlighter-rouge">common</code>、<code class="language-plaintext highlighter-rouge">post</code>、<code class="language-plaintext highlighter-rouge">get</code> 等属性，而这些属性中的值才是我们要真正添加到请求 <code class="language-plaintext highlighter-rouge">header</code> 中的。</p>

<p>举个例子：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">headers</span><span class="p">:</span> <span class="p">{</span>
  <span class="nl">common</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">Accept</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json, text/plain, */*</span><span class="dl">'</span>
  <span class="p">},</span>
  <span class="nx">post</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">application/x-www-form-urlencoded</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我们需要把它压成一级的，如下：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">headers</span><span class="p">:</span> <span class="p">{</span>
  <span class="nl">Accept</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json, text/plain, */*</span><span class="dl">'</span><span class="p">,</span>
 <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span><span class="dl">'</span><span class="s1">application/x-www-form-urlencoded</span><span class="dl">'</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这里要注意的是，对于 <code class="language-plaintext highlighter-rouge">common</code> 中定义的 <code class="language-plaintext highlighter-rouge">header</code> 字段，我们都要提取，而对于 <code class="language-plaintext highlighter-rouge">post</code>、<code class="language-plaintext highlighter-rouge">get</code> 这类提取，需要和该次请求的方法对应。</p>

<p>接下来我们实现 <code class="language-plaintext highlighter-rouge">flattenHeaders</code> 方法。</p>

<p><code class="language-plaintext highlighter-rouge">helpers/header.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">flattenHeaders</span><span class="p">(</span><span class="nx">headers</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">method</span><span class="p">:</span> <span class="nx">Method</span><span class="p">):</span> <span class="kr">any</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">headers</span>
  <span class="p">}</span>
  <span class="nx">headers</span> <span class="o">=</span> <span class="nx">deepMerge</span><span class="p">(</span><span class="nx">headers</span><span class="p">.</span><span class="nx">common</span> <span class="o">||</span> <span class="p">{},</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="o">||</span> <span class="p">{},</span> <span class="nx">headers</span><span class="p">)</span>

  <span class="kd">const</span> <span class="nx">methodsToDelete</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">delete</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">get</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">head</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">options</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">put</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">patch</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">common</span><span class="dl">'</span><span class="p">]</span>

  <span class="nx">methodsToDelete</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">method</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span>
  <span class="p">})</span>

  <span class="k">return</span> <span class="nx">headers</span>
<span class="p">}</span>
</code></pre></div></div>

<p>我们可以通过 <code class="language-plaintext highlighter-rouge">deepMerge</code> 的方式把 <code class="language-plaintext highlighter-rouge">common</code>、<code class="language-plaintext highlighter-rouge">post</code> 的属性拷贝到 <code class="language-plaintext highlighter-rouge">headers</code> 这一级，然后再把 <code class="language-plaintext highlighter-rouge">common</code>、<code class="language-plaintext highlighter-rouge">post</code> 这些属性删掉。</p>

<p>然后我们在真正发送请求前执行这个逻辑。</p>

<p><code class="language-plaintext highlighter-rouge">core/dispatchRequest.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">processConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">transformURL</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="nx">transformHeaders</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">transformRequestData</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="nx">flattenHeaders</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">method</span><span class="o">!</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这样确保我们了配置中的 <code class="language-plaintext highlighter-rouge">headers</code> 是可以正确添加到请求 <code class="language-plaintext highlighter-rouge">header</code> 中的</p>

<h2 id="demo-编写">demo 编写</h2>

<p>在 <code class="language-plaintext highlighter-rouge">examples</code> 目录下创建 <code class="language-plaintext highlighter-rouge">config</code> 目录，在 <code class="language-plaintext highlighter-rouge">config</code> 目录下创建 <code class="language-plaintext highlighter-rouge">index.html</code>:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Config example<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/__build__/config.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>接着创建 <code class="language-plaintext highlighter-rouge">app.ts</code> 作为入口文件：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../src/index</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">qs</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">qs</span><span class="dl">'</span>

<span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">common</span><span class="p">[</span><span class="dl">'</span><span class="s1">test2</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">123</span>

<span class="nx">axios</span><span class="p">({</span>
  <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/config/post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
    <span class="na">a</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">}),</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">test</span><span class="p">:</span> <span class="dl">'</span><span class="s1">321</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>这个例子中我们额外引入了 <code class="language-plaintext highlighter-rouge">qs</code> 库，它是一个查询字符串解析和字符串化的库。</p>

<p>比如我们的例子中对于 <code class="language-plaintext highlighter-rouge">{a:1}</code> 经过 <code class="language-plaintext highlighter-rouge">qs.stringify</code> 变成 <code class="language-plaintext highlighter-rouge">a=1</code>。</p>

<p>由于我们的例子给默认值添加了 <code class="language-plaintext highlighter-rouge">post</code> 和 <code class="language-plaintext highlighter-rouge">common</code> 的 <code class="language-plaintext highlighter-rouge">headers</code>，我们在请求前做配置合并，于是我们请求的 <code class="language-plaintext highlighter-rouge">header</code> 就添加了 <code class="language-plaintext highlighter-rouge">Content-Type</code> 字段，它的值是 <code class="language-plaintext highlighter-rouge">application/x-www-form-urlencoded</code>；另外我们也添加了 <code class="language-plaintext highlighter-rouge">test2</code> 字段，它的值是 <code class="language-plaintext highlighter-rouge">123</code>。</p>

<p>至此，我们合并配置的逻辑就实现完了。我们在前面的章节编写 <code class="language-plaintext highlighter-rouge">axios</code> 的基础功能的时候对请求数据和响应数据都做了处理，官方 <code class="language-plaintext highlighter-rouge">axios</code> 则把这俩部分逻辑也做到了默认配置中，意味这用户可以去修改这俩部分的逻辑，实现自己对请求和响应数据处理的逻辑。那么下一节我们就来实现这个 feature。</p>
