<h1 id="扩展-axioscreate-静态接口">扩展 axios.create 静态接口</h1>

<h2 id="需求分析">需求分析</h2>

<p>目前为止，我们的 axios 都是一个单例，一旦我们修改了 axios 的默认配置，会影响所有的请求。我们希望提供了一个 <code class="language-plaintext highlighter-rouge">axios.create</code> 的静态接口允许我们创建一个新的 <code class="language-plaintext highlighter-rouge">axios</code> 实例，同时允许我们传入新的配置和默认配置合并，并做为新的默认配置。</p>

<p>举个例子：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
  <span class="na">transformRequest</span><span class="p">:</span> <span class="p">[(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">}),</span> <span class="p">...(</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">transformRequest</span> <span class="k">as</span> <span class="nx">AxiosTransformer</span><span class="p">[])],</span>
  <span class="na">transformResponse</span><span class="p">:</span> <span class="p">[...(</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">transformResponse</span> <span class="k">as</span> <span class="nx">AxiosTransformer</span><span class="p">[]),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">data</span>
  <span class="p">}]</span>
<span class="p">})</span>

<span class="nx">instance</span><span class="p">({</span>
  <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/config/post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">a</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="静态方法扩展">静态方法扩展</h2>

<p>由于 <code class="language-plaintext highlighter-rouge">axios</code> 扩展了一个静态接口，因此我们先来修改接口类型定义。</p>

<p><code class="language-plaintext highlighter-rouge">types/index.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kr">interface</span> <span class="nx">AxiosStatic</span> <span class="kd">extends</span> <span class="nx">AxiosInstance</span><span class="p">{</span>
  <span class="nx">create</span><span class="p">(</span><span class="nx">config</span><span class="p">?:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosInstance</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">create</code> 函数可以接受一个 <code class="language-plaintext highlighter-rouge">AxiosRequestConfig</code> 类型的配置，作为默认配置的扩展，也可以接受不传参数。</p>

<p>接着我们来实现 <code class="language-plaintext highlighter-rouge">axios.create</code> 静态方法。</p>

<p><code class="language-plaintext highlighter-rouge">axios.ts</code>：</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">createInstance</span><span class="p">(</span><span class="nx">config</span><span class="p">:</span> <span class="nx">AxiosRequestConfig</span><span class="p">):</span> <span class="nx">AxiosStatic</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Axios</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">Axios</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span>

  <span class="nx">extend</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">instance</span> <span class="k">as</span> <span class="nx">AxiosStatic</span>
<span class="p">}</span>
<span class="nx">axios</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">create</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">createInstance</span><span class="p">(</span><span class="nx">mergeConfig</span><span class="p">(</span><span class="nx">defaults</span><span class="p">,</span> <span class="nx">config</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<p>内部调用了 <code class="language-plaintext highlighter-rouge">createInstance</code> 函数，并且把参数 <code class="language-plaintext highlighter-rouge">config</code> 与 <code class="language-plaintext highlighter-rouge">defaults</code> 合并，作为新的默认配置。注意这里我们需要 <code class="language-plaintext highlighter-rouge">createInstance</code> 函数的返回值类型为 <code class="language-plaintext highlighter-rouge">AxiosStatic</code>。</p>

<h2 id="demo-编写">demo 编写</h2>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">instance</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
  <span class="na">transformRequest</span><span class="p">:</span> <span class="p">[(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">}),</span> <span class="p">...(</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">transformRequest</span> <span class="k">as</span> <span class="nx">AxiosTransformer</span><span class="p">[])],</span>
  <span class="na">transformResponse</span><span class="p">:</span> <span class="p">[...(</span><span class="nx">axios</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">transformResponse</span> <span class="k">as</span> <span class="nx">AxiosTransformer</span><span class="p">[]),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">data</span>
  <span class="p">}]</span>
<span class="p">})</span>

<span class="nx">instance</span><span class="p">({</span>
  <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/config/post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">a</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>我们对上节课的示例做了小小的修改，通过 <code class="language-plaintext highlighter-rouge">axios.create</code> 方法创建一个新的实例 <code class="language-plaintext highlighter-rouge">instance</code>，并传入了 <code class="language-plaintext highlighter-rouge">transformRequest</code> 和 <code class="language-plaintext highlighter-rouge">transformResponse</code> 的配置修改了默认配置，然后通过 <code class="language-plaintext highlighter-rouge">instance</code> 发送请求，效果和之前是一样的。</p>

<p>至此我们实现了 <code class="language-plaintext highlighter-rouge">axios.create</code> 静态接口的扩展，整个 <code class="language-plaintext highlighter-rouge">ts-axios</code> 的配置化也告一段落。官方 axios 库还支持了对请求取消的能力，在发送请求前以及请求发送出去未响应前都可以取消该请求。下一章我们就来实现这个 feature。</p>
